<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CS Math Quest — Catch‑Up Arcade</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121935;
      --panel2: #0e1530;
      --acc: #6cf;
      --acc2: #9f6cff;
      --good: #2ecc71;
      --bad: #e74c3c;
      --text: #e6ecff;
      --muted: #9fb0d7;
    }

    /* THEMES */
    [data-theme="space"] {
      --bg: #0a0f1f;
      --panel: #111936;
      --panel2: #0c1430;
      --acc: #60a5fa;
      /* blue-400 */
      --acc2: #a78bfa;
      /* violet-400 */
      --good: #22c55e;
      /* green-500 */
      --bad: #ef4444;
      /* red-500 */
      --text: #f8fafc;
      /* slate-50 */
      --muted: #cbd5e1;
      /* slate-300 */
    }

    [data-theme="ice"] {
      --bg: #0a1326;
      --panel: #0e1a3d;
      --panel2: #0a1f4a;
      --acc: #7dd3fc;
      /* sky-300 */
      --acc2: #c7d2fe;
      /* indigo-200 */
      --good: #34d399;
      /* emerald-400 */
      --bad: #f87171;
      /* red-400 */
      --text: #f1f5f9;
      /* slate-100 */
      --muted: #d1e9ff;
      /* light cyan */
    }

    [data-theme="jungle"] {
      --bg: #0a140c;
      --panel: #0e2616;
      --panel2: #0a331f;
      --acc: #86efac;
      /* green-300 */
      --acc2: #4ade80;
      /* green-400 */
      --good: #16a34a;
      /* green-600 */
      --bad: #f97316;
      /* orange-500 for better CB distinction */
      --text: #ecfdf5;
      /* emerald-50 */
      --muted: #b7e4c7;
      /* mint */
    }

    [data-theme="dungeon"] {
      --bg: #0e0c09;
      --panel: #171208;
      --panel2: #241a0b;
      --acc: #fbbf24;
      /* amber-400 */
      --acc2: #f59e0b;
      /* amber-500 */
      --good: #22c55e;
      /* green-500 */
      --bad: #ef4444;
      /* red-500 */
      --text: #fff7ed;
      /* orange-50 */
      --muted: #f5deb3;
      /* warm sand */
    }

    [data-theme="workshop"] {
      --bg: #140f0a;
      --panel: #1b140e;
      --panel2: #231a12;
      --acc: #f59e0b;
      /* amber-500 */
      --acc2: #f97316;
      /* orange-500 */
      --good: #22c55e;
      /* green-500 */
      --bad: #ef4444;
      /* red-500 */
      --text: #fff1e6;
      --muted: #e2c8b5;
    }

    [data-theme="portal"] {
      --bg: #130a19;
      --panel: #1b1030;
      --panel2: #2b1550;
      --acc: #a78bfa;
      /* violet-400 */
      --acc2: #f472b6;
      /* pink-400 */
      --good: #10b981;
      /* emerald-500 */
      --bad: #f43f5e;
      /* rose-500 */
      --text: #f5f3ff;
      /* violet-50 */
      --muted: #d6bcfa;
      /* violet-200 */
    }

    /* Improve meter contrast */
    .meter>span {
      background: linear-gradient(90deg, #16a34a, #2563eb);
      /* green-600 → blue-600 */
    }

    /* Stronger focus outline for clarity */
    :focus-visible {
      outline: 3px solid var(--acc);
      outline-offset: 3px;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: radial-gradient(1000px 600px at 80% -10%, #1e2c6f22 0, transparent 60%), radial-gradient(1200px 800px at -10% 110%, #9f6cff14 0, transparent 70%), var(--bg);
      color: var(--text);
      font: 16px/1.4 system-ui, Segoe UI, Roboto, Inter, sans-serif
    }

    .app {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: 100vh
    }

    header {
      grid-column: 1/-1;
      background: linear-gradient(90deg, var(--panel2), #1a2555);
      padding: 14px 18px;
      border-bottom: 1px solid #263164;
      display: flex;
      align-items: center;
      gap: 16px
    }

    header h1 {
      font-size: 20px;
      margin: 0;
      letter-spacing: .4px
    }

    .stat {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #0b1230;
      border: 1px solid #2a3672;
      padding: 6px 10px;
      border-radius: 10px
    }

    .stat b {
      color: #fff
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-left: auto
    }

    .side {
      background: linear-gradient(180deg, var(--panel), #0c1433);
      border-right: 1px solid #28346e;
      padding: 12px
    }

    .sectionTitle {
      margin: 10px 0 6px;
      color: #bcd3ff;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 1.4px
    }

    .navBtn {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #2a3672;
      background: #0b1230;
      color: #e6ecff;
      cursor: pointer;
      margin: 6px 0;
      transition: .15s
    }

    .navBtn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px #0005
    }

    .navBtn.active {
      outline: 2px solid var(--acc)
    }

    .progress {
      height: 6px;
      background: #19224b;
      border-radius: 999px;
      overflow: hidden
    }

    .progress>span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, var(--acc), var(--acc2));
      width: 0%
    }

    main {
      padding: 18px 18px 48px
    }

    .card {
      background: linear-gradient(180deg, var(--panel), #0f1738);
      border: 1px solid #2b3a78;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 30px #0006
    }

    .grid {
      display: grid;
      gap: 16px
    }

    @media(min-width:980px) {
      .grid {
        grid-template-columns: 1.1fr .9fr
      }
    }

    h2 {
      margin: 4px 0 12px
    }

    .question {
      font-size: 22px;
      letter-spacing: .2px
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace
    }

    .pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #34448a;
      background: #0b1230;
      color: #bcd3ff;
      font-size: 12px
    }

    input[type=number],
    input[type=text] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #2c3a77;
      background: #0d1433;
      color: #e6ecff
    }

    .btn {
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid #2c3a77;
      background: linear-gradient(180deg, #1a2555, #0d1433);
      color: #fff;
      cursor: pointer
    }

    .btn:hover {
      filter: brightness(1.08)
    }

    .btn.ghost {
      background: #0b1230
    }

    .feedback {
      margin-top: 10px;
      font-weight: 700
    }

    .good {
      color: var(--good)
    }

    .bad {
      color: var(--bad)
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #151e44;
      border: 1px solid #2a3672;
      border-radius: 12px;
      padding: 6px 10px;
      margin: 4px 6px 0 0
    }

    .tiny {
      font-size: 12px;
      color: var(--muted)
    }

    .hint {
      margin-top: 10px;
      color: #ffd980
    }

    .kbd {
      border: 1px solid #2a3672;
      border-bottom-width: 3px;
      border-radius: 8px;
      padding: 2px 6px;
      background: #0b1230
    }

    .flex {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    .right {
      margin-left: auto
    }

    .footer {
      opacity: .8;
      font-size: 12px;
      margin-top: 8px
    }

    /* FX canvas behind content */
    #fx {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 0;
    }

    /* ensure UI sits above FX */
    header,
    .app {
      position: relative;
      z-index: 1;
    }

    /* Mastery glow */
    .pill.mastered {
      color: #ffd76a;
      border-color: #ffcf67;
      box-shadow: 0 0 12px #ffcf6755, inset 0 0 8px #ffcf6722;
      background: linear-gradient(180deg, #1d1a08, #0f0b02);
    }

    /* Subtle hover lift */
    .btn:hover {
      box-shadow: 0 6px 16px #0007;
      transform: translateY(-1px);
    }

    /* Symbol legend */
    .legend-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 12px;
      margin-top: 8px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .legend-sym {
      min-width: 44px;
      text-align: center;
      font-size: 20px;
      padding: 4px 8px;
      border: 1px solid #2a3672;
      border-radius: 10px;
      background: #0b1230;
      color: #e6ecff;
    }

    .legend-note {
      font-size: 12px;
      color: var(--muted);
    }

    /* Engagement UI */
    .meter {
      height: 8px;
      background: #19224b;
      border-radius: 999px;
      overflow: hidden;
    }

    .meter>span {
      display: block;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #2ecc71, #6cf);
      transition: width .3s;
    }

    .challenge {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 8px;
      border: 1px solid #2a3672;
      border-radius: 10px;
      background: #0b1230;
    }

    .challenge.done {
      opacity: .7;
      filter: saturate(.7);
    }

    .challenge .prog {
      margin-left: auto;
      font-size: 12px;
      color: var(--muted);
    }

    .challenge .check {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 1px solid #2a3672;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #0d1433;
      color: #2ecc71;
    }

    .stats-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin: 6px 0;
    }

    .stats-row .pill {
      min-width: 140px;
      text-align: center;
    }

    .muted {
      color: var(--muted);
    }

    /* Accessibility helpers */
    .sr-only {
      position: absolute !important;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0 0 0 0);
      white-space: nowrap;
      border: 0;
    }

    .skip-link {
      position: absolute;
      left: 8px;
      top: -40px;
      z-index: 2;
      background: #151e44;
      color: #fff;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #2a3672;
      transition: top .2s;
    }

    .skip-link:focus {
      top: 8px;
    }

    /* Quest Picker modal */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: #0009;
      z-index: 3;
      padding: 16px;
    }

    .modal.show {
      display: flex;
    }

    .modal .dialog {
      width: min(720px, 96vw);
      background: linear-gradient(180deg, var(--panel), #0f1738);
      border: 1px solid #2b3a78;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 30px #000c;
    }

    .qp-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }

    .qp-btn {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #2a3672;
      background: #0b1230;
      color: #e6ecff;
      cursor: pointer;
    }

    .qp-btn .tiny {
      color: var(--muted);
    }

    /* Question correct pulse */
    .qPulse {
      animation: qpulse .6s ease-out;
    }

    @keyframes qpulse {
      0% {
        box-shadow: 0 0 0 0 rgba(34, 197, 94, .45);
      }

      100% {
        box-shadow: 0 0 0 22px rgba(34, 197, 94, 0);
      }
    }

    /* XP floaters */
    .xp-floater {
      position: fixed;
      z-index: 9999;
      pointer-events: none;
      font-weight: 700;
      color: #ffd76a;
      text-shadow: 0 2px 8px #0008;
      transform: translate(-50%, 0);
      animation: floatUp .85s ease-out forwards;
    }

    .xp-floater.neg {
      color: #f87171;
    }

    @keyframes floatUp {
      to {
        transform: translate(-50%, -28px);
        opacity: 0;
      }
    }

    /* Progress bar bump glow on increase */
    .progress>span.bump {
      animation: barBump .6s ease-out;
    }

    @keyframes barBump {
      0% {
        filter: brightness(1.3);
        box-shadow: 0 0 0 0 var(--acc);
      }

      100% {
        filter: none;
        box-shadow: 0 0 0 16px transparent;
      }
    }
  </style>
</head>

<body>
  <a href="#main" class="skip-link">Skip to main content</a>
  <canvas id="fx" aria-hidden="true"></canvas>
  <header>
    <h1>🕹️ CS Math Quest</h1>
    <div class="row">
      <div class="stat" title="Experience Points"><span>⭐</span> <span>XP:</span> <b id="xp">0</b></div>
      <div class="stat" title="Streak"><span>🔥</span> <span>Streak:</span> <b id="streak">0</b></div>
      <div class="stat" title="Rank"><span>🏆</span> <span>Rank:</span> <b id="rank">Novice</b></div>
      <label for="themeSelect" class="sr-only">Theme</label>
      <select id="themeSelect" class="btn ghost" title="Theme">
        <option value="auto">Auto (by Quest)</option>
        <option value="space">Space</option>
        <option value="ice">Ice Caves</option>
        <option value="jungle">Jungle</option>
        <option value="dungeon">Temple</option>
        <option value="workshop">Workshop</option>
        <option value="portal">Portal</option>
      </select>
      <!-- ADDED: Reset button (needed by JS binding) -->
      <button class="btn ghost" id="resetBtn" title="Reset progress" aria-label="Reset progress">↺ Reset</button>
    </div>
  </header>
  <div class="app">
    <aside class="side" role="navigation" aria-label="Quest Map">
      <div class="sectionTitle">Quest Map</div>
      <button class="navBtn active" data-mode="pemdas">Q1) Temple of PEMDAS <span class="pill mono"
          id="p_pemdas">0/10</span></button>
      <button class="navBtn" data-mode="integers">Q2) Integer Ice Caves <span class="pill mono"
          id="p_integers">0/10</span></button>
      <button class="navBtn" data-mode="coords">Q3) Quadrant Frontier <span class="pill mono"
          id="p_coords">0/10</span></button>
      <button class="navBtn" data-mode="words">Q4) Wordsmith Workshop <span class="pill mono"
          id="p_words">0/10</span></button>
      <button class="navBtn" data-mode="puzzles">Q5) Puzzle Portal <span class="pill mono"
          id="p_puzzles">0/10</span></button>
      <!-- NEW -->
      <button class="navBtn" data-mode="logic">Q6) Circuit of Logic <span class="pill mono"
          id="p_logic">0/10</span></button>
      <button class="navBtn" data-mode="mod">Q7) Modulus Monastery <span class="pill mono"
          id="p_mod">0/10</span></button>
      <!-- ADD: Mixed quest -->
      <button class="navBtn" data-mode="mix">Q8) Mixed Gauntlet <span class="pill mono" id="p_mix">0/10</span></button>
      <div class="sectionTitle">Progress</div>
      <div class="tiny" title="Mastery is checked on a rolling window of your last 20 attempts in each strand.">
        Mastery = 90%+ over last 20, 25+ attempts total, ≤10% hints, median ≤25s, across ≥2 days.
      </div>
      <div class="progress" style="margin:8px 0 6px"><span id="overallBar"></span></div>
      <div class="tiny" id="overallPct">0% complete</div>
      <div class="sectionTitle">Badges</div>
      <div id="badges"></div>
    </aside>

    <main id="main" role="main">
      <div class="grid">
        <section class="card">
          <h2 id="modeTitle">Q1: Temple of PEMDAS</h2>
          <div class="tiny">Tip: Use parentheses like you would in code to control precedence.</div>
          <div id="qWrap" style="margin-top:10px">
            <div class="question mono" id="question">Loading…</div>
            <div class="flex" style="margin-top:12px">
              <input id="answer" type="text" inputmode="text" placeholder="Enter your answer"
                aria-label="Your answer" />
              <button class="btn" id="submit">Submit</button>
              <button class="btn ghost" id="newQ">New</button>
              <button class="btn ghost" id="hintBtn" title="Costs 5 XP">💡 Hint</button>
              <span class="right pill" id="strandLabel">PEMDAS</span>
            </div>
            <!-- NEW: On-screen keypad -->
            <div id="keypad" class="flex tiny" style="gap:6px; margin-top:8px">
              <button type="button" class="btn ghost kp" data-insert="*">×</button>
              <button type="button" class="btn ghost kp" data-insert="/">÷</button>
              <button type="button" class="btn ghost kp" data-insert="-">−</button>
              <button type="button" class="btn ghost kp" data-insert="^">^</button>
              <button type="button" class="btn ghost kp" data-insert="T">T</button>
              <button type="button" class="btn ghost kp" data-insert="F">F</button>
              <button type="button" class="btn ghost kp-clear" title="Clear input">Clear</button>
            </div>
            <div class="feedback" id="feedback" role="status" aria-live="polite"></div>
            <div class="hint" id="hint" style="display:none"></div>
          </div>
          <div class="footer">Keyboard: <span class="kbd">Enter</span> to submit, <span class="kbd">N</span> new, <span
              class="kbd">H</span> hint.</div>
        </section>

        <section class="card">
          <h3>Strand Progress</h3>
          <div class="flex">
            <div class="pill">PEMDAS</div>
            <div class="progress" style="flex:1"><span id="bar_pemdas"></span></div>
          </div>
          <div class="flex">
            <div class="pill">Integers</div>
            <div class="progress" style="flex:1"><span id="bar_integers"></span></div>
          </div>
          <div class="flex">
            <div class="pill">Coordinates</div>
            <div class="progress" style="flex:1"><span id="bar_coords"></span></div>
          </div>
          <div class="flex">
            <div class="pill">Word</div>
            <div class="progress" style="flex:1"><span id="bar_words"></span></div>
          </div>
          <div class="flex">
            <div class="pill">Puzzles</div>
            <div class="progress" style="flex:1"><span id="bar_puzzles"></span></div>
          </div>
          <!-- NEW -->
          <div class="flex">
            <div class="pill">Logic</div>
            <div class="progress" style="flex:1"><span id="bar_logic"></span></div>
          </div>
          <div class="flex">
            <div class="pill">Modulus</div>
            <div class="progress" style="flex:1"><span id="bar_mod"></span></div>
          </div>
          <!-- ADD: Mixed progress row -->
          <div class="flex">
            <div class="pill">Mixed</div>
            <div class="progress" style="flex:1"><span id="bar_mix"></span></div>
          </div>
          <div style="margin-top:10px" class="tiny">
            When mastered, the strand pill shows “Mastered” and the bar fills. Correct = +10 XP (+2/step streak), Hint =
            −5 XP.
          </div>
        </section>

        <!-- NEW: Symbol Legend card -->
        <section class="card">
          <!-- Collapsible legend -->
          <details id="legend" open>
            <summary style="cursor:pointer; font-weight:600; list-style:none">
              <h3 style="display:inline; margin:0">Symbol Legend</h3>
            </summary>
            <div class="legend-grid" style="margin-top:8px">
              <!-- Arithmetic -->
              <div class="legend-item"><span class="legend-sym">×</span>
                <div>Multiply <span class="legend-note">(keyboard: <span class="kbd">*</span>)</span></div>
              </div>
              <div class="legend-item"><span class="legend-sym">÷</span>
                <div>Divide <span class="legend-note">(keyboard: <span class="kbd">/</span>)</span></div>
              </div>
              <div class="legend-item"><span class="legend-sym">−</span>
                <div>Subtract <span class="legend-note">(keyboard: <span class="kbd">-</span>)</span></div>
              </div>
              <div class="legend-item"><span class="legend-sym">^</span>
                <div>Exponent <span class="legend-note">(e.g., 2^3 = 8)</span></div>
              </div>
              <div class="legend-item"><span class="legend-sym">|x|</span>
                <div>Absolute value</div>
              </div>
              <div class="legend-item"><span class="legend-sym">T / F</span>
                <div>Truth values <span class="legend-note">(type T or F)</span></div>
              </div>
              <div class="legend-item"><span class="legend-sym">mod</span>
                <div>Remainder <span class="legend-note">(e.g., 17 mod 5 = 2)</span></div>
              </div>
            </div>
            <div class="tiny" style="margin-top:8px;">
              Tip: Answers can be numbers, T/F, or simplified fractions (a/b). Use <span class="kbd">*</span>, <span
                class="kbd">/</span>, <span class="kbd">-</span>, and <span class="kbd">^</span>.
            </div>
          </details>
        </section>

        <!-- NEW: Daily Goal -->
        <section class="card">
          <h3>Today's CS Goal</h3>
          <div class="tiny">Solve enough with good accuracy and low hint use.</div>
          <!-- NEW: day-specific label -->
          <div class="tiny" id="dailyGoalLabel" style="margin-top:4px;"></div>
          <div class="flex" style="margin-top:8px">
            <div class="pill">Today</div>
            <div class="right tiny">Completed: <b id="dailyCount">0/10</b></div>
          </div>
          <div class="meter" style="margin-top:8px"><span id="dailyBar"></span></div>
          <!-- NEW: criteria checklist -->
          <div id="dailyChecklist" class="tiny" style="display:grid; gap:6px; margin-top:8px"></div>
          <div class="tiny" id="dailyHint" style="margin-top:6px; opacity:.9"></div>
        </section>

        <!-- NEW: Daily Challenges -->
        <section class="card">
          <h3>Daily Challenges</h3>
          <div class="tiny">Complete mini‑goals for extra XP and fun.</div>
          <div id="challenges" style="display:grid; gap:8px; margin-top:8px"></div>
        </section>

        <!-- NEW: Strand Stats -->
        <section class="card">
          <div class="flex" style="justify-content: space-between; align-items: center;">
            <h3 style="margin:0">Strand Stats</h3>
            <button class="btn ghost tiny" id="resetStatsBtn"
              title="Clear stats shown below (does not change XP or progress)">Reset Stats</button>
          </div>
          <div id="statsBox" class="tiny"></div>
        </section>
      </div>
    </main>
  </div>

  <script>
    (function () {
      // Focus feature removed: global no‑op stubs (prevent legacy call errors)
      window.ensureFocus = window.ensureFocus || function () { };
      window.currentFocusPlan = window.currentFocusPlan || function () { return { accept: () => false }; };
      window.updateFocusUI = window.updateFocusUI || function () { };
      // If badges painter is not present, keep as no-op to avoid crashes on reset
      window.paintBadges = window.paintBadges || function () { };

      // Utility to safely call optional functions if they exist
      function callIf(fn, ...args) { if (typeof fn === 'function') return fn(...args); }

      // --- FX: starfield + confetti (single instance) ---
      const fx = document.getElementById('fx');
      const ctx = fx.getContext('2d');
      let W = 0, H = 0, stars = [], confetti = [];
      function resizeFX() { W = fx.width = window.innerWidth; H = fx.height = window.innerHeight; }
      window.addEventListener('resize', resizeFX); resizeFX();
      function initStars(n = 120) {
        stars = Array.from({ length: n }, () => ({
          x: Math.random() * W, y: Math.random() * H, r: Math.random() * 1.2 + 0.3,
          a: Math.random() * Math.PI * 2, s: 0.2 + Math.random() * 0.6
        }));
      }
      initStars();
      // ADD: shooting stars state + spawner (used in fxLoop)
      let shooting = [];
      function spawnShootingStar() {
        const y = Math.random() * H * 0.5 + 10;
        shooting.push({
          x: Math.random() * W * 0.6 + W * 0.2,
          y,
          vx: -6 - Math.random() * 3,
          vy: 1.5 + Math.random(),
          life: 24 + (Math.random() * 16),
          alpha: .9
        });
      }
      // FIX: define prefersReducedMotion before first use
      const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      // Patch fxLoop to draw shooting stars (keeps existing stars + confetti)
      const _fxLoop = fxLoop;
      function fxLoop() {
        // occasional spawn
        if (!prefersReducedMotion && Math.random() < 0.02 && shooting.length < 3) spawnShootingStar();

        ctx.clearRect(0, 0, W, H);

        // stars
        ctx.save();
        for (const st of stars) {
          st.a += 0.02; const tw = (Math.sin(st.a) + 1) * 0.5;
          ctx.globalAlpha = 0.3 + tw * 0.7; ctx.fillStyle = '#9fb0d7';
          ctx.beginPath(); ctx.arc(st.x, st.y, st.r, 0, Math.PI * 2); ctx.fill();
          st.y += st.s * 0.15; if (st.y > H + 2) { st.y = -2; st.x = Math.random() * W; }
        }
        ctx.restore();

        // shooting stars
        if (!prefersReducedMotion && shooting.length) {
          ctx.save();
          for (let i = shooting.length - 1; i >= 0; i--) {
            const s = shooting[i];
            ctx.globalAlpha = Math.max(0, s.alpha);
            ctx.strokeStyle = '#cde3ff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(s.x, s.y);
            ctx.lineTo(s.x + 16, s.y - 6);
            ctx.stroke();
            s.x += s.vx; s.y += s.vy; s.life -= 1; s.alpha -= 0.04;
            if (s.life <= 0 || s.x < -20 || s.y > H + 20) shooting.splice(i, 1);
          }
          ctx.restore();
        }

        // confetti (unchanged)
        ctx.save();
        for (let i = confetti.length - 1; i >= 0; i--) {
          const p = confetti[i];
          p.vy += p.g; p.x += p.vx; p.y += p.vy; p.rot += p.vr; p.life -= 1;
          p.alpha = Math.max(0, p.life / 100);
          ctx.globalAlpha = p.alpha; ctx.fillStyle = p.color;
          ctx.translate(p.x, p.y); ctx.rotate(p.rot);
          ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h); ctx.setTransform(1, 0, 0, 1, 0, 0);
          if (p.life <= 0 || p.y > H + 20) confetti.splice(i, 1);
        }
        ctx.restore();

        requestAnimationFrame(fxLoop);
      }
      // replace loop with patched one
      if (!prefersReducedMotion) requestAnimationFrame(fxLoop);

      function celebrate(kind = 'correct') {
        if (prefersReducedMotion) return;
        const anchor = document.getElementById('qWrap');
        const rect = anchor ? anchor.getBoundingClientRect() : { left: W / 2, top: H / 3, right: W / 2, height: 0 };
        const cx = (rect.left + (rect.right ?? rect.left)) / 2; const cy = rect.top + 10;
        if (kind === 'mastery') addConfetti({ x: cx, y: cy, count: 160, spread: 1.4, colors: ['#ffd76a', '#ffcf67', '#fff2b0', '#9f6cff'] });
        else addConfetti({ x: cx, y: cy, count: 80, spread: 1.0 });
      }

      // --- Nav: single init with guard ---
      function setActiveNav(btn) {
        const btns = [...document.querySelectorAll('.navBtn')];
        btns.forEach(b => { b.classList.remove('active'); b.removeAttribute('aria-current'); });
        btn.classList.add('active'); btn.setAttribute('aria-current', 'page');
      }
      function initNav() {
        if (initNav._done) return;
        const btns = [...document.querySelectorAll('.navBtn')];
        btns.forEach(btn => {
          if (btn.dataset.bound) return;
          btn.addEventListener('click', () => {
            setActiveNav(btn);
            data.mode = btn.dataset.mode;
            renderMode();
            callIf(window.nextQuestion);
            // Auto theme switches with quest
            if (data.themePref === 'auto') applyTheme('auto');
            save();
          });
          btn.dataset.bound = '1';
        });
        const initActive = document.querySelector('.navBtn.active');
        if (initActive) initActive.setAttribute('aria-current', 'page');
        initNav._done = true;
      }

      // --- Core state (single) ---
      const STRANDS = ['pemdas', 'integers', 'coords', 'words', 'puzzles', 'logic', 'mod', 'mix']; // + mix
      const state = JSON.parse(localStorage.getItem('csMathQuest') || '{}');
      const data = Object.assign({
        xp: 0, streak: 0, rank: 'Novice', mode: 'pemdas',
        correct: { pemdas: 0, integers: 0, coords: 0, words: 0, puzzles: 0, logic: 0, mod: 0, mix: 0 },
        hist: { pemdas: [], integers: [], coords: [], words: [], puzzles: [], logic: [], mod: [], mix: [] },
        mastered: { pemdas: false, integers: false, coords: false, words: false, puzzles: false, logic: false, mod: false, mix: false },
        daily: { date: '', solved: 0, goal: 20, completed: false, rules: { minSolved: 10, minAcc: 0.80, maxHintRate: 0.10 } },
        challenges: [],
        badges: {},
        boss: { done: false },
        themePref: 'auto',
        statsWin: { pemdas: [], integers: [], coords: [], words: [], puzzles: [], logic: [], mod: [], mix: [] },
        statsMode: 'hist'
      }, state);
      function ensureDataShape() {
        for (const k of STRANDS) {
          if (!data.correct || typeof data.correct[k] !== 'number') { if (!data.correct) data.correct = {}; if (!Number.isFinite(data.correct[k])) data.correct[k] = 0; }
          if (!data.hist || !Array.isArray(data.hist[k])) { if (!data.hist) data.hist = {}; if (!Array.isArray(data.hist[k])) data.hist[k] = []; }
          if (!data.mastered || typeof data.mastered[k] !== 'boolean') { if (!data.mastered) data.mastered = {}; if (typeof data.mastered[k] !== 'boolean') data.mastered[k] = false; }
          if (!data.statsWin || !Array.isArray(data.statsWin[k])) { if (!data.statsWin) data.statsWin = {}; if (!Array.isArray(data.statsWin[k])) data.statsWin[k] = []; }
        }
      }
      ensureDataShape();

      // --- Helpers (single) ---
      function $(sel) { return document.querySelector(sel); }
      function setText(sel, val) { const el = document.querySelector(sel); if (el) el.textContent = val; }
      function fmtPct(n) { return Math.round(Math.max(0, Math.min(1, n)) * 100) + '%'; }
      function save() { try { localStorage.setItem('csMathQuest', JSON.stringify(data)); } catch (_) { } }
      function toast(msg) {
        const el = document.createElement('div'); el.textContent = msg;
        Object.assign(el.style, { position: 'fixed', top: '12px', right: '12px', zIndex: 9999, background: '#151e44', color: '#fff', border: '1px solid #2a3672', padding: '8px 10px', borderRadius: '10px', boxShadow: '0 6px 20px #0008', opacity: '0', transform: 'translateY(-6px)', transition: 'opacity .2s, transform .2s' });
        document.body.appendChild(el);
        requestAnimationFrame(() => { el.style.opacity = '1'; el.style.transform = 'translateY(0)'; });
        setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateY(-6px)'; setTimeout(() => el.remove(), 250); }, 2000);
      }
      // ADD: HUD updater (fixes ReferenceError)
      function updateHUD() {
        setText('#xp', String(data.xp || 0));
        setText('#streak', String(data.streak || 0));
        setText('#rank', data.rank || 'Novice');
        if (typeof updateHintButton === 'function') updateHintButton();
      }

    // function celebrate(kind = 'correct') { ... } already defined above; remove duplicate/incomplete definition.