<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CS Math Quest — Catch‑Up Arcade</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121935;
      --panel2: #0e1530;
      --acc: #6cf;
      --acc2: #9f6cff;
      --good: #2ecc71;
      --bad: #e74c3c;
      --text: #e6ecff;
      --muted: #9fb0d7;
    }

    /* THEMES */
    [data-theme="space"] {
      --bg: #0b1020;
      --panel: #121935;
      --panel2: #0e1530;
      --acc: #6cf;
      --acc2: #9f6cff;
      --good: #2ecc71;
      --bad: #e74c3c;
      --text: #e6ecff;
      --muted: #9fb0d7;
    }

    [data-theme="ice"] {
      --bg: #0a1224;
      --panel: #0f1a3a;
      --panel2: #0b1f47;
      --acc: #77d9ff;
      --acc2: #b3ecff;
      --good: #5ce6b8;
      --bad: #ff6b6b;
      --text: #eef7ff;
      --muted: #b7d2ea;
    }

    [data-theme="jungle"] {
      --bg: #0b140d;
      --panel: #0f2616;
      --panel2: #0c331f;
      --acc: #5de38a;
      --acc2: #9cff6c;
      --good: #4de07a;
      --bad: #ff6b6b;
      --text: #e8ffe8;
      --muted: #a7d7b1;
    }

    [data-theme="dungeon"] {
      --bg: #0e0c09;
      --panel: #171208;
      --panel2: #241a0b;
      --acc: #ffcf67;
      --acc2: #ffd76a;
      --good: #8be881;
      --bad: #ff6b6b;
      --text: #fff5e2;
      --muted: #d7c7a0;
    }

    [data-theme="workshop"] {
      --bg: #140f0a;
      --panel: #1b140e;
      --panel2: #231a12;
      --acc: #ffad66;
      --acc2: #ffd180;
      --good: #8be881;
      --bad: #ff7d7d;
      --text: #fff0e0;
      --muted: #d7c0a7;
    }

    [data-theme="portal"] {
      --bg: #120a18;
      --panel: #1b0f2a;
      --panel2: #2a1342;
      --acc: #9f6cff;
      --acc2: #ff6cd9;
      --good: #78f0c8;
      --bad: #ff6b9e;
      --text: #f6eaff;
      --muted: #c9b3e0;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: radial-gradient(1000px 600px at 80% -10%, #1e2c6f22 0, transparent 60%), radial-gradient(1200px 800px at -10% 110%, #9f6cff14 0, transparent 70%), var(--bg);
      color: var(--text);
      font: 16px/1.4 system-ui, Segoe UI, Roboto, Inter, sans-serif
    }

    .app {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: 100vh
    }

    header {
      grid-column: 1/-1;
      background: linear-gradient(90deg, var(--panel2), #1a2555);
      padding: 14px 18px;
      border-bottom: 1px solid #263164;
      display: flex;
      align-items: center;
      gap: 16px
    }

    header h1 {
      font-size: 20px;
      margin: 0;
      letter-spacing: .4px
    }

    .stat {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #0b1230;
      border: 1px solid #2a3672;
      padding: 6px 10px;
      border-radius: 10px
    }

    .stat b {
      color: #fff
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-left: auto
    }

    .side {
      background: linear-gradient(180deg, var(--panel), #0c1433);
      border-right: 1px solid #28346e;
      padding: 12px
    }

    .sectionTitle {
      margin: 10px 0 6px;
      color: #bcd3ff;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 1.4px
    }

    .navBtn {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #2a3672;
      background: #0b1230;
      color: #e6ecff;
      cursor: pointer;
      margin: 6px 0;
      transition: .15s
    }

    .navBtn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px #0005
    }

    .navBtn.active {
      outline: 2px solid var(--acc)
    }

    .progress {
      height: 6px;
      background: #19224b;
      border-radius: 999px;
      overflow: hidden
    }

    .progress>span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, var(--acc), var(--acc2));
      width: 0%
    }

    main {
      padding: 18px 18px 48px
    }

    .card {
      background: linear-gradient(180deg, var(--panel), #0f1738);
      border: 1px solid #2b3a78;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 30px #0006
    }

    .grid {
      display: grid;
      gap: 16px
    }

    @media(min-width:980px) {
      .grid {
        grid-template-columns: 1.1fr .9fr
      }
    }

    h2 {
      margin: 4px 0 12px
    }

    .question {
      font-size: 22px;
      letter-spacing: .2px
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace
    }

    .pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #34448a;
      background: #0b1230;
      color: #bcd3ff;
      font-size: 12px
    }

    input[type=number],
    input[type=text] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #2c3a77;
      background: #0d1433;
      color: #e6ecff
    }

    .btn {
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid #2c3a77;
      background: linear-gradient(180deg, #1a2555, #0d1433);
      color: #fff;
      cursor: pointer
    }

    .btn:hover {
      filter: brightness(1.08)
    }

    .btn.ghost {
      background: #0b1230
    }

    .feedback {
      margin-top: 10px;
      font-weight: 700
    }

    .good {
      color: var(--good)
    }

    .bad {
      color: var(--bad)
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #151e44;
      border: 1px solid #2a3672;
      border-radius: 12px;
      padding: 6px 10px;
      margin: 4px 6px 0 0
    }

    .tiny {
      font-size: 12px;
      color: var(--muted)
    }

    .hint {
      margin-top: 10px;
      color: #ffd980
    }

    .kbd {
      border: 1px solid #2a3672;
      border-bottom-width: 3px;
      border-radius: 8px;
      padding: 2px 6px;
      background: #0b1230
    }

    .flex {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    .right {
      margin-left: auto
    }

    .footer {
      opacity: .8;
      font-size: 12px;
      margin-top: 8px
    }

    /* FX canvas behind content */
    #fx {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 0;
    }

    /* ensure UI sits above FX */
    header,
    .app {
      position: relative;
      z-index: 1;
    }

    /* Mastery glow */
    .pill.mastered {
      color: #ffd76a;
      border-color: #ffcf67;
      box-shadow: 0 0 12px #ffcf6755, inset 0 0 8px #ffcf6722;
      background: linear-gradient(180deg, #1d1a08, #0f0b02);
    }

    /* Subtle hover lift */
    .btn:hover {
      box-shadow: 0 6px 16px #0007;
      transform: translateY(-1px);
    }

    /* Symbol legend */
    .legend-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 12px;
      margin-top: 8px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .legend-sym {
      min-width: 44px;
      text-align: center;
      font-size: 20px;
      padding: 4px 8px;
      border: 1px solid #2a3672;
      border-radius: 10px;
      background: #0b1230;
      color: #e6ecff;
    }

    .legend-note {
      font-size: 12px;
      color: var(--muted);
    }

    /* Engagement UI */
    .meter {
      height: 8px;
      background: #19224b;
      border-radius: 999px;
      overflow: hidden;
    }

    .meter>span {
      display: block;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #2ecc71, #6cf);
      transition: width .3s;
    }

    .challenge {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 8px;
      border: 1px solid #2a3672;
      border-radius: 10px;
      background: #0b1230;
    }

    .challenge.done {
      opacity: .7;
      filter: saturate(.7);
    }

    .challenge .prog {
      margin-left: auto;
      font-size: 12px;
      color: var(--muted);
    }

    .challenge .check {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 1px solid #2a3672;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #0d1433;
      color: #2ecc71;
    }

    .stats-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin: 6px 0;
    }

    .stats-row .pill {
      min-width: 140px;
      text-align: center;
    }

    .muted {
      color: var(--muted);
    }

    /* Accessibility helpers */
    .sr-only {
      position: absolute !important;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0 0 0 0);
      white-space: nowrap;
      border: 0;
    }

    .skip-link {
      position: absolute;
      left: 8px;
      top: -40px;
      z-index: 2;
      background: #151e44;
      color: #fff;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #2a3672;
      transition: top .2s;
    }

    .skip-link:focus {
      top: 8px;
    }

    :focus-visible {
      outline: 3px solid var(--acc);
      outline-offset: 2px;
    }

    /* Quest Picker modal */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: #0009;
      z-index: 3;
      padding: 16px;
    }

    .modal.show {
      display: flex;
    }

    .modal .dialog {
      width: min(720px, 96vw);
      background: linear-gradient(180deg, var(--panel), #0f1738);
      border: 1px solid #2b3a78;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 30px #000c;
    }

    .qp-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }

    .qp-btn {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #2a3672;
      background: #0b1230;
      color: #e6ecff;
      cursor: pointer;
    }

    .qp-btn .tiny {
      color: var(--muted);
    }
  </style>
</head>

<body>
  <a href="#main" class="skip-link">Skip to main content</a>
  <canvas id="fx" aria-hidden="true"></canvas>
  <header>
    <h1>🕹️ CS Math Quest</h1>
    <div class="row">
      <div class="stat" title="Experience Points"><span>⭐</span> <span>XP:</span> <b id="xp">0</b></div>
      <div class="stat" title="Streak"><span>🔥</span> <span>Streak:</span> <b id="streak">0</b></div>
      <div class="stat" title="Rank"><span>🏆</span> <span>Rank:</span> <b id="rank">Novice</b></div>
      <label for="themeSelect" class="sr-only">Theme</label>
      <select id="themeSelect" class="btn ghost" title="Theme">
        <option value="auto">Auto (by Quest)</option>
        <option value="space">Space</option>
        <option value="ice">Ice Caves</option>
        <option value="jungle">Jungle</option>
        <option value="dungeon">Temple</option>
        <option value="workshop">Workshop</option>
        <option value="portal">Portal</option>
      </select>
      <!-- ADDED: Reset button (needed by JS binding) -->
      <button class="btn ghost" id="resetBtn" title="Reset progress" aria-label="Reset progress">↺ Reset</button>
    </div>
  </header>
  <div class="app">
    <aside class="side" role="navigation" aria-label="Quest Map">
      <div class="sectionTitle">Quest Map</div>
      <button class="navBtn active" data-mode="pemdas">Q1) Temple of PEMDAS <span class="pill mono"
          id="p_pemdas">0/10</span></button>
      <button class="navBtn" data-mode="integers">Q2) Integer Ice Caves <span class="pill mono"
          id="p_integers">0/10</span></button>
      <button class="navBtn" data-mode="coords">Q3) Quadrant Frontier <span class="pill mono"
          id="p_coords">0/10</span></button>
      <button class="navBtn" data-mode="words">Q4) Wordsmith Workshop <span class="pill mono"
          id="p_words">0/10</span></button>
      <button class="navBtn" data-mode="puzzles">Q5) Puzzle Portal <span class="pill mono"
          id="p_puzzles">0/10</span></button>
      <!-- NEW -->
      <button class="navBtn" data-mode="logic">Q6) Circuit of Logic <span class="pill mono"
          id="p_logic">0/10</span></button>
      <button class="navBtn" data-mode="mod">Q7) Modulus Monastery <span class="pill mono"
          id="p_mod">0/10</span></button>
      <button class="navBtn" data-mode="prob">Q8) Probability Pirates <span class="pill mono"
          id="p_prob">0/10</span></button>
      <div class="sectionTitle">Progress</div>
      <div class="tiny" title="Mastery is checked on a rolling window of your last 20 attempts in each strand.">
        Mastery = 90%+ over last 20, 25+ attempts total, ≤10% hints, median ≤25s, across ≥2 days.
      </div>
      <div class="progress" style="margin:8px 0 6px"><span id="overallBar"></span></div>
      <div class="tiny" id="overallPct">0% complete</div>
      <div class="sectionTitle">Badges</div>
      <div id="badges"></div>
    </aside>

    <main id="main" role="main">
      <div class="grid">
        <section class="card">
          <h2 id="modeTitle">Q1: Temple of PEMDAS</h2>
          <div class="tiny">Tip: Use parentheses like you would in code to control precedence.</div>
          <div id="qWrap" style="margin-top:10px">
            <div class="question mono" id="question">Loading…</div>
            <div class="flex" style="margin-top:12px">
              <input id="answer" type="text" inputmode="text" placeholder="Enter your answer"
                aria-label="Your answer" />
              <button class="btn" id="submit">Submit</button>
              <button class="btn ghost" id="newQ">New</button>
              <button class="btn ghost" id="hintBtn" title="Costs 5 XP">💡 Hint</button>
              <span class="right pill" id="strandLabel">PEMDAS</span>
            </div>
            <div class="feedback" id="feedback" role="status" aria-live="polite"></div>
            <div class="hint" id="hint" style="display:none"></div>
          </div>
          <div class="footer">Keyboard: <span class="kbd">Enter</span> to submit, <span class="kbd">N</span> new, <span
              class="kbd">H</span> hint.</div>
        </section>

        <section class="card">
          <h3>Strand Progress</h3>
          <div class="flex">
            <div class="pill">PEMDAS</div>
            <div class="progress" style="flex:1"><span id="bar_pemdas"></span></div>
          </div>
          <div class="flex">
            <div class="pill">Integers</div>
            <div class="progress" style="flex:1"><span id="bar_integers"></span></div>
          </div>
          <div class="flex">
            <div class="pill">Coordinates</div>
            <div class="progress" style="flex:1"><span id="bar_coords"></span></div>
          </div>
          <div class="flex">
            <div class="pill">Word</div>
            <div class="progress" style="flex:1"><span id="bar_words"></span></div>
          </div>
          <div class="flex">
            <div class="pill">Puzzles</div>
            <div class="progress" style="flex:1"><span id="bar_puzzles"></span></div>
          </div>
          <!-- NEW -->
          <div class="flex">
            <div class="pill">Logic</div>
            <div class="progress" style="flex:1"><span id="bar_logic"></span></div>
          </div>
          <div class="flex">
            <div class="pill">Modulus</div>
            <div class="progress" style="flex:1"><span id="bar_mod"></span></div>
          </div>
          <div class="flex">
            <div class="pill">Probability</div>
            <div class="progress" style="flex:1"><span id="bar_prob"></span></div>
          </div>
          <div style="margin-top:10px" class="tiny">
            When mastered, the strand pill shows “Mastered” and the bar fills. Correct = +10 XP (+2/step streak), Hint =
            −5 XP.
          </div>
        </section>

        <!-- NEW: Symbol Legend card -->
        <section class="card">
          <h3>Symbol Legend</h3>
          <div class="legend-grid">
            <!-- Arithmetic -->
            <div class="legend-item"><span class="legend-sym">×</span>
              <div>Multiply <span class="legend-note">(keyboard: <span class="kbd">*</span>)</span></div>
            </div>
            <div class="legend-item"><span class="legend-sym">÷</span>
              <div>Divide <span class="legend-note">(keyboard: <span class="kbd">/</span>)</span></div>
            </div>
            <div class="legend-item"><span class="legend-sym">−</span>
              <div>Subtract <span class="legend-note">(keyboard: <span class="kbd">-</span>)</span></div>
            </div>
            <div class="legend-item"><span class="legend-sym">^</span>
              <div>Exponent <span class="legend-note">(e.g., 2^3 = 8)</span></div>
            </div>
            <div class="legend-item"><span class="legend-sym">|x|</span>
              <div>Absolute value</div>
            </div>
            <!-- Logic -->
            <div class="legend-item"><span class="legend-sym">∧</span>
              <div>AND <span class="legend-note">(true only if both true)</span></div>
            </div>
            <div class="legend-item"><span class="legend-sym">∨</span>
              <div>OR <span class="legend-note">(true if at least one true)</span></div>
            </div>
            <div class="legend-item"><span class="legend-sym">¬</span>
              <div>NOT <span class="legend-note">(negation)</span></div>
            </div>
            <div class="legend-item"><span class="legend-sym">→</span>
              <div>Implies <span class="legend-note">(A→B false when A=T, B=F)</span></div>
            </div>
            <div class="legend-item"><span class="legend-sym">T / F</span>
              <div>Truth values <span class="legend-note">(type T or F)</span></div>
            </div>
            <!-- Modulus -->
            <div class="legend-item"><span class="legend-sym">mod</span>
              <div>Remainder <span class="legend-note">(e.g., 17 mod 5 = 2)</span></div>
            </div>
            <div class="legend-item"><span class="legend-sym">≡ (mod n)</span>
              <div>Congruent mod n <span class="legend-note">(same remainder)</span></div>
            </div>
            <div class="legend-item"><span class="legend-sym">even/odd</span>
              <div>Parity <span class="legend-note">(n mod 2)</span></div>
            </div>
            <!-- Probability -->
            <div class="legend-item"><span class="legend-sym">P(A)</span>
              <div>Probability of A</div>
            </div>
            <div class="legend-item"><span class="legend-sym">∩ / ∪</span>
              <div>And / Or of events <span class="legend-note">(intersection/union)</span></div>
            </div>
            <div class="legend-item"><span class="legend-sym">A′</span>
              <div>Complement of A</div>
            </div>
            <div class="legend-item"><span class="legend-sym">a/b</span>
              <div>Simplified fraction <span class="legend-note">(e.g., 2/6 → 1/3)</span></div>
            </div>
          </div>
          <div class="tiny" style="margin-top:8px;">
            Tip: Answers can be numbers, T/F, or simplified fractions (a/b). Use keyboard symbols like <span
              class="kbd">*</span>, <span class="kbd">/</span>, <span class="kbd">-</span>, and <span
              class="kbd">^</span>.
          </div>
        </section>

        <!-- NEW: Daily Goal -->
        <section class="card">
          <h3>Today's CS Goal</h3>
          <div class="tiny">Solve enough with good accuracy and low hint use.</div>
          <!-- NEW: day-specific label -->
          <div class="tiny" id="dailyGoalLabel" style="margin-top:4px;"></div>
          <div class="flex" style="margin-top:8px">
            <div class="pill">Today</div>
            <div class="right tiny">Completed: <b id="dailyCount">0/10</b></div>
          </div>
          <div class="meter" style="margin-top:8px"><span id="dailyBar"></span></div>
          <!-- NEW: criteria checklist -->
          <div id="dailyChecklist" class="tiny" style="display:grid; gap:6px; margin-top:8px"></div>
          <div class="tiny" id="dailyHint" style="margin-top:6px; opacity:.9"></div>
        </section>

        <!-- NEW: Daily Challenges -->
        <section class="card">
          <h3>Daily Challenges</h3>
          <div class="tiny">Complete mini‑goals for extra XP and fun.</div>
          <div id="challenges" style="display:grid; gap:8px; margin-top:8px"></div>
        </section>

        <!-- NEW: Strand Stats -->
        <section class="card">
          <div class="flex" style="justify-content: space-between; align-items: center;">
            <h3 style="margin:0">Strand Stats</h3>
            <button class="btn ghost tiny" id="resetStatsBtn"
              title="Clear stats shown below (does not change XP or progress)">Reset Stats</button>
          </div>
          <div id="statsBox" class="tiny"></div>
        </section>
      </div>
    </main>
  </div>

  <script>
    (function () {
      // Focus feature removed: global no‑op stubs (prevent legacy call errors)
      window.ensureFocus = window.ensureFocus || function () { };
      window.currentFocusPlan = window.currentFocusPlan || function () { return { accept: () => false }; };
      window.updateFocusUI = window.updateFocusUI || function () { };

      // Utility to safely call optional functions if they exist
      function callIf(fn, ...args) { if (typeof fn === 'function') return fn(...args); }

      // --- FX: starfield + confetti (single instance) ---
      const fx = document.getElementById('fx');
      const ctx = fx.getContext('2d');
      let W = 0, H = 0, stars = [], confetti = [];
      function resizeFX() { W = fx.width = window.innerWidth; H = fx.height = window.innerHeight; }
      window.addEventListener('resize', resizeFX); resizeFX();
      function initStars(n = 120) {
        stars = Array.from({ length: n }, () => ({
          x: Math.random() * W, y: Math.random() * H, r: Math.random() * 1.2 + 0.3,
          a: Math.random() * Math.PI * 2, s: 0.2 + Math.random() * 0.6
        }));
      }
      initStars();
      function addConfetti({ x = W / 2, y = H / 2, count = 80, spread = 1, colors = ['#6cf', '#9f6cff', '#2ecc71', '#ffd76a'] } = {}) {
        for (let i = 0; i < count; i++) {
          const ang = Math.random() * Math.PI * 2, spd = (2 + Math.random() * 4) * spread;
          confetti.push({
            x, y, vx: Math.cos(ang) * spd, vy: Math.sin(ang) * spd - 2,
            g: 0.06 + Math.random() * 0.08, life: 60 + Math.random() * 40,
            color: colors[(Math.random() * colors.length) | 0],
            w: 2 + Math.random() * 3, h: 6 + Math.random() * 8,
            rot: Math.random() * Math.PI, vr: (Math.random() - 0.5) * 0.3, alpha: 1
          });
        }
      }
      function fxLoop() {
        ctx.clearRect(0, 0, W, H);
        // stars
        ctx.save();
        for (const st of stars) {
          st.a += 0.02; const tw = (Math.sin(st.a) + 1) * 0.5;
          ctx.globalAlpha = 0.3 + tw * 0.7; ctx.fillStyle = '#9fb0d7';
          ctx.beginPath(); ctx.arc(st.x, st.y, st.r, 0, Math.PI * 2); ctx.fill();
          st.y += st.s * 0.15; if (st.y > H + 2) { st.y = -2; st.x = Math.random() * W; }
        }
        ctx.restore();
        // confetti
        ctx.save();
        for (let i = confetti.length - 1; i >= 0; i--) {
          const p = confetti[i];
          p.vy += p.g; p.x += p.vx; p.y += p.vy; p.rot += p.vr; p.life -= 1;
          p.alpha = Math.max(0, p.life / 100);
          ctx.globalAlpha = p.alpha; ctx.fillStyle = p.color;
          ctx.translate(p.x, p.y); ctx.rotate(p.rot);
          ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h); ctx.setTransform(1, 0, 0, 1, 0, 0);
          if (p.life <= 0 || p.y > H + 20) confetti.splice(i, 1);
        }
        ctx.restore();
        requestAnimationFrame(fxLoop);
      }
      const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (!prefersReducedMotion) requestAnimationFrame(fxLoop); else { const fxCanvas = document.getElementById('fx'); if (fxCanvas) fxCanvas.style.display = 'none'; }
      function celebrate(kind = 'correct') {
        if (prefersReducedMotion) return;
        const anchor = document.getElementById('qWrap');
        const rect = anchor ? anchor.getBoundingClientRect() : { left: W / 2, top: H / 3, right: W / 2, height: 0 };
        const cx = (rect.left + (rect.right ?? rect.left)) / 2; const cy = rect.top + 10;
        if (kind === 'mastery') addConfetti({ x: cx, y: cy, count: 160, spread: 1.4, colors: ['#ffd76a', '#ffcf67', '#fff2b0', '#9f6cff'] });
        else addConfetti({ x: cx, y: cy, count: 80, spread: 1.0 });
      }

      // --- Nav: single init with guard ---
      function setActiveNav(btn) {
        const btns = [...document.querySelectorAll('.navBtn')];
        btns.forEach(b => { b.classList.remove('active'); b.removeAttribute('aria-current'); });
        btn.classList.add('active'); btn.setAttribute('aria-current', 'page');
      }
      function initNav() {
        if (initNav._done) return;
        const btns = [...document.querySelectorAll('.navBtn')];
        btns.forEach(btn => {
          if (btn.dataset.bound) return;
          btn.addEventListener('click', () => {
            setActiveNav(btn);
            data.mode = btn.dataset.mode;
            renderMode();
            callIf(window.nextQuestion);
            if (data.themePref === 'auto') callIf(window.applyTheme, themeForMode(data.mode));
            save();
          });
          btn.dataset.bound = '1';
        });
        const initActive = document.querySelector('.navBtn.active');
        if (initActive) initActive.setAttribute('aria-current', 'page');
        initNav._done = true;
      }

      // --- Core state (single) ---
      const STRANDS = ['pemdas', 'integers', 'coords', 'words', 'puzzles', 'logic', 'mod', 'prob'];
      const state = JSON.parse(localStorage.getItem('csMathQuest') || '{}');
      const data = Object.assign({
        xp: 0, streak: 0, rank: 'Novice', mode: 'pemdas',
        correct: { pemdas: 0, integers: 0, coords: 0, words: 0, puzzles: 0, logic: 0, mod: 0, prob: 0 },
        hist: { pemdas: [], integers: [], coords: [], words: [], puzzles: [], logic: [], mod: [], prob: [] },
        mastered: { pemdas: false, integers: false, coords: false, words: false, puzzles: false, logic: false, mod: false, prob: false },
        daily: { date: '', solved: 0, goal: 20, completed: false, rules: { minSolved: 10, minAcc: 0.80, maxHintRate: 0.10 } },
        challenges: [],
        badges: {},
        boss: { done: false },
        themePref: 'auto',
        statsWin: { pemdas: [], integers: [], coords: [], words: [], puzzles: [], logic: [], mod: [], prob: [] },
        statsMode: 'hist'
      }, state);
      function ensureDataShape() {
        for (const k of STRANDS) {
          if (!data.correct || typeof data.correct[k] !== 'number') { if (!data.correct) data.correct = {}; if (!Number.isFinite(data.correct[k])) data.correct[k] = 0; }
          if (!data.hist || !Array.isArray(data.hist[k])) { if (!data.hist) data.hist = {}; if (!Array.isArray(data.hist[k])) data.hist[k] = []; }
          if (!data.mastered || typeof data.mastered[k] !== 'boolean') { if (!data.mastered) data.mastered = {}; if (typeof data.mastered[k] !== 'boolean') data.mastered[k] = false; }
          if (!data.statsWin || !Array.isArray(data.statsWin[k])) { if (!data.statsWin) data.statsWin = {}; if (!Array.isArray(data.statsWin[k])) data.statsWin[k] = []; }
        }
      }
      ensureDataShape();

      // --- Helpers (single) ---
      function $(sel) { return document.querySelector(sel); }
      function setText(sel, val) { const el = document.querySelector(sel); if (el) el.textContent = val; }
      function fmtPct(n) { return Math.round(Math.max(0, Math.min(1, n)) * 100) + '%'; }
      function save() { try { localStorage.setItem('csMathQuest', JSON.stringify(data)); } catch (_) { } }
      function toast(msg) {
        const el = document.createElement('div'); el.textContent = msg;
        Object.assign(el.style, { position: 'fixed', top: '12px', right: '12px', zIndex: 9999, background: '#151e44', color: '#fff', border: '1px solid #2a3672', padding: '8px 10px', borderRadius: '10px', boxShadow: '0 6px 20px #0008', opacity: '0', transform: 'translateY(-6px)', transition: 'opacity .2s, transform .2s' });
        document.body.appendChild(el);
        requestAnimationFrame(() => { el.style.opacity = '1'; el.style.transform = 'translateY(0)'; });
        setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateY(-6px)'; setTimeout(() => el.remove(), 250); }, 2000);
      }
      function updateHUD() { setText('#xp', String(data.xp)); setText('#streak', String(data.streak)); setText('#rank', data.rank); }
      function paintBadges() {
        const box = document.getElementById('badges'); if (!box) return;
        box.innerHTML = ''; Object.values(data.badges || {}).forEach(label => { const el = document.createElement('div'); el.className = 'badge'; el.innerHTML = `🏅 <span>${label}</span>`; box.appendChild(el); });
      }

      // --- Mastery & Progress (single) ---
      function median(arr) { if (!arr.length) return 0; const s = [...arr].sort((a, b) => a - b); const m = Math.floor(s.length / 2); return s.length % 2 ? s[m] : (s[m - 1] + s[m]) / 2; }
      function dayKey(ts) { const d = new Date(ts); return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`; }
      function computeMasteryFor(strand) {
        const attempts = data.hist[strand] || []; const total = attempts.length; const window20 = attempts.slice(-20);
        if (total < 25 || window20.length < 20) return false;
        const acc = window20.reduce((s, a) => s + (a.correct ? 1 : 0), 0) / window20.length; if (acc < 0.90) return false;
        const days = new Set(window20.map(a => dayKey(a.t))).size; if (days < 2) return false;
        const medMs = median(window20.map(a => a.ms || 0)); if (medMs > 25000) return false;
        const hintRate = window20.reduce((s, a) => s + (a.hint ? 1 : 0), 0) / window20.length; if (hintRate > 0.10) return false;
        return true;
      }
      function recomputeMastery() { STRANDS.forEach(k => { data.mastered[k] = computeMasteryFor(k); }); }
      function updateProgress() {
        recomputeMastery();
        STRANDS.forEach(k => {
          const pill = document.getElementById('p_' + k);
          const bar = document.getElementById('bar_' + k);
          if (data.mastered[k]) {
            if (pill) { pill.textContent = 'Mastered'; pill.classList.add('mastered'); }
            if (bar) bar.style.width = '100%';
          } else {
            if (pill) { pill.textContent = `${data.correct[k]}/10`; pill.classList.remove('mastered'); }
            if (bar) bar.style.width = Math.min(100, (data.correct[k] || 0) * 10) + '%';
          }
        });
        const total = STRANDS.reduce((s, k) => s + (data.correct[k] || 0), 0);
        const pct = (STRANDS.length ? total / (STRANDS.length * 10) : 0);
        const overall = document.getElementById('overallBar'); if (overall) overall.style.width = Math.min(100, Math.max(0, pct * 100)) + '%';
        setText('#overallPct', fmtPct(pct));
      }
      function computeRank(xp) { if (xp >= 300) return 'Architect'; if (xp >= 150) return 'Hacker'; if (xp >= 50) return 'Coder'; return 'Novice'; }

      // --- Mode/title + theme helpers (single) ---
      function themeForMode(mode) {
        switch (mode) {
          case 'pemdas': return 'dungeon';
          case 'integers': return 'ice';
          case 'coords': return 'space';
          case 'words': return 'workshop';
          case 'puzzles': return 'portal';
          case 'logic': return 'workshop';
          case 'mod': return 'dungeon';
          case 'prob': return 'jungle';
          default: return 'space';
        }
      }
      function renderMode() {
        const titles = {
          pemdas: 'Q1: Temple of PEMDAS', integers: 'Q2: Integer Ice Caves', coords: 'Q3: Quadrant Frontier',
          words: 'Q4: Wordsmith Workshop', puzzles: 'Q5: Puzzle Portal', logic: 'Q6: Circuit of Logic',
          mod: 'Q7: Modulus Monastery', prob: 'Q8: Probability Pirates', boss: 'Boss Battle: Final Gauntlet'
        };
        setText('#modeTitle', titles[data.mode] || 'Quest');
        setText('#strandLabel', (data.mode || '').toUpperCase().replace('PUZZLES', 'PUZZLES'));
      }

      // --- Daily (stubs kept minimal; your existing robust logic can sit elsewhere) ---
      function todayKey() { return new Date().toISOString().slice(0, 10); }
      function rollDailyChallenges() {
        const strands = STRANDS; const pick = strands[(Math.random() * strands.length) | 0];
        return [
          { id: 'c_strand', label: `Solve 8 in ${pick.toUpperCase()}`, type: 'strand', strand: pick, progress: 0, target: 8, done: false, reward: 35 },
          { id: 'c_streak', label: 'Get a 5‑answer streak', type: 'streak', progress: 0, target: 5, done: false, reward: 30 },
          { id: 'c_nohint', label: 'Answer 6 with no hints', type: 'nohint', progress: 0, target: 6, done: false, reward: 30 },
          { id: 'c_speed', label: 'Speedster: 3 correct under 15s', type: 'speed', threshold: 15, progress: 0, target: 3, done: false, reward: 25 },
        ];
      }
      function ensureDaily() {
        const today = todayKey();
        if (!data.daily || data.daily.date !== today) {
          data.daily = { date: today, solved: 0, goal: 10, completed: false, rules: { minSolved: 10, minAcc: 0.80, maxHintRate: 0.10 } };
          data.challenges = rollDailyChallenges();
        } else if (!Array.isArray(data.challenges) || !data.challenges.length) {
          data.challenges = rollDailyChallenges();
        }
        callIf(window.updateEngagementUI);
      }

      // --- Reset binding (single) ---
      const resetEl = document.getElementById('resetBtn');
      if (resetEl && !resetEl.dataset.bound) {
        resetEl.addEventListener('click', () => {
          if (!confirm('Reset XP, progress, and daily challenges?')) return;
          data.xp = 0; data.streak = 0; data.rank = 'Novice';
          data.correct = STRANDS.reduce((o, k) => (o[k] = 0, o), {});
          data.hist = STRANDS.reduce((o, k) => (o[k] = [], o), {});
          data.mastered = STRANDS.reduce((o, k) => (o[k] = false, o), {});
          data.badges = {}; data.boss = { done: false };
          data.daily = null; data.challenges = []; ensureDaily();
          updateHUD(); updateProgress(); paintBadges(); callIf(window.updateEngagementUI);
          save(); callIf(window.nextQuestion);
        });
        resetEl.dataset.bound = '1';
      }

      // --- Init: bind nav, randomize quest on load, render once ---
      initNav();
      ensureDaily();

      // INSERT: core generators, answer checking, controls, and UI updates
      // --- Generators (one per strand) ---
      const rnd = (a, b) => (Math.random() * (b - a + 1) + a) | 0;
      const choice = a => a[(Math.random() * a.length) | 0];
      function reduceFrac(n, d) {
        const g = (x, y) => y ? g(y, x % y) : Math.abs(x);
        const gg = g(n, d) || 1;
        const s = Math.sign(n) * Math.sign(d) || 1;
        n = Math.abs(n) / gg; d = Math.abs(d) / gg;
        return { n: s < 0 ? -n : n, d };
      }
      const gens = {
        pemdas() {
          const a = rnd(2, 12), b = rnd(2, 9), c = rnd(1, 8), d = rnd(1, 6);
          const ops = [['+', (x, y) => x + y], ['-', (x, y) => x - y]];
          const [s, f] = choice(ops);
          const expr = `${a} + ${b} * (${c} ${s} ${d})`;
          const ans = a + b * f(c, d);
          return { q: `Evaluate: ${expr}`, ans, hint: 'Do parentheses first, then multiply, then add/subtract.' };
        },
        integers() {
          const a = rnd(-20, 20), b = rnd(-20, 20), op = choice(['+', '-', '*']);
          const expr = `${a} ${op} ${b}`;
          const ans = op === '+' ? a + b : op === '-' ? a - b : a * b;
          return { q: `Compute: ${expr}`, ans, hint: 'Remember: negative × negative = positive.' };
        },
        coords() {
          const x = rnd(-9, 9), y = rnd(-9, 9);
          const ans = x + y;
          return { q: `Point P(${x}, ${y}). What is x + y?`, ans, hint: 'Add the x and y coordinates.' };
        },
        words() {
          const a = rnd(3, 12), b = rnd(2, 9);
          return { q: `Translate and compute: "the product of ${a} and ${b}, then add ${a}"`, ans: a * b + a, hint: 'Product means multiply, then add.' };
        },
        puzzles() {
          const a = rnd(2, 6), d = rnd(2, 7), n = rnd(5, 8);
          const seq = Array.from({ length: n - 1 }, (_, i) => a + i * d).join(', ');
          const ans = a + (n - 1) * d;
          return { q: `Sequence: ${seq}, … What is the ${n}ᵗʰ term?`, ans, hint: `Arithmetic seq: aₙ = a₁ + (n−1)d (d=${d}).` };
        },
        logic() {
          const A = Math.random() < 0.5, B = Math.random() < 0.5;
          const op = choice(['∧', '∨', '→']);
          let ans;
          if (op === '∧') ans = A && B;
          else if (op === '∨') ans = A || B;
          else ans = (!A) || B; // implication
          return { q: `Let A=${A ? 'T' : 'F'}, B=${B ? 'T' : 'F'}. Evaluate: A ${op} B`, ans: ans ? 'T' : 'F', hint: 'A→B is false only when A=T and B=F.' };
        },
        mod() {
          const n = rnd(10, 99), m = choice([3, 4, 5, 6, 7, 8, 9]);
          return { q: `Compute: ${n} mod ${m}`, ans: n % m, hint: 'Remainder after dividing n by m.' };
        },
        prob() {
          // Die roll: probability of rolling value ≤ k
          const k = choice([2, 3, 4, 5]);
          const n = k, d = 6; const rf = reduceFrac(n, d);
          return { q: `Roll a fair die. P(value ≤ ${k}) = ? (simplify as a/b)`, ans: `${rf.n}/${rf.d}`, hint: `Favorable outcomes: ${n} of 6.` };
        }
      };

      // --- Answer normalization and compare ---
      function norm(input) {
        if (typeof input === 'number') return { kind: 'num', v: input };
        if (typeof input === 'string') {
          const s = input.trim();
          if (/^[tTfF]$/.test(s)) return { kind: 'bool', v: s.toUpperCase() };
          if (/^-?\d+\/-?\d+$/.test(s)) {
            const [a, b] = s.split('/').map(Number);
            if (b === 0) return { kind: 'str', v: s };
            const { n, d } = reduceFrac(a, b);
            return { kind: 'frac', v: `${n}/${d}` };
          }
          if (/^-?\d+(\.\d+)?$/.test(s)) return { kind: 'num', v: Number(s) };
          return { kind: 'str', v: s };
        }
        return { kind: 'str', v: String(input) };
      }
      function eqAns(user, correct) {
        const u = norm(user), c = norm(correct);
        if (u.kind === 'bool' || c.kind === 'bool') return u.v === (typeof c.v === 'string' ? c.v.toUpperCase() : c.v);
        if (u.kind === 'frac' || c.kind === 'frac') return u.v === (c.kind === 'frac' ? c.v : String(c.v));
        if (u.kind === 'num' && c.kind === 'num') return Math.abs(u.v - c.v) < 1e-9;
        return String(user).trim().toLowerCase() === String(correct).trim().toLowerCase();
      }

      // --- Challenges (HS level) ---
      function applyChallengeProgress({ correct, noHint, strand, ms = 0, streak = 0 }) {
        if (!Array.isArray(data.challenges) || !data.challenges.length) return;
        let changed = false;
        for (const ch of data.challenges) {
          if (ch.done) continue;
          switch (ch.type) {
            case 'strand':
              if (correct && strand === ch.strand) { ch.progress++; changed = true; }
              break;
            case 'streak': {
              const prog = Math.min(streak, ch.target);
              if (prog > (ch.progress || 0)) { ch.progress = prog; changed = true; }
              break;
            }
            case 'nohint':
              if (correct && noHint) { ch.progress++; changed = true; }
              break;
            case 'speed': {
              const thrMs = Math.max(1000, (ch.threshold || 15) * 1000);
              if (correct && ms > 0 && ms <= thrMs) { ch.progress++; changed = true; }
              break;
            }
          }
          if (!ch.done && ch.progress >= ch.target) {
            ch.done = true;
            const reward = ch.reward || 20;
            data.xp += reward;
            data.rank = computeRank(data.xp);
            toast(`🎯 Challenge complete! (+${reward} XP)`);
            celebrate('correct');
            changed = true;
          }
        }
        if (changed) { updateHUD(); save(); updateEngagementUI(); }
      }

      // --- Engagement UI (daily + challenges) ---
      function updateEngagementUI() {
        // Daily meter
        const solved = data.daily?.solved || 0;
        const goal = data.daily?.goal || 10;
        const bar = document.getElementById('dailyBar');
        if (bar) bar.style.width = Math.min(100, Math.max(0, (solved / goal) * 100)) + '%';
        const cnt = document.getElementById('dailyCount');
        if (cnt) cnt.textContent = `${Math.min(solved, goal)}/${goal}`;
        // Challenges list
        const box = document.getElementById('challenges');
        if (box) {
          box.innerHTML = '';
          (data.challenges || []).forEach(ch => {
            const row = document.createElement('div');
            row.className = 'challenge' + (ch.done ? ' done' : '');
            row.innerHTML = `
              <span class="check">${ch.done ? '✔' : ''}</span>
              <div>${ch.label}</div>
              <div class="prog">${Math.min(ch.progress, ch.target)}/${ch.target}</div>
            `;
            box.appendChild(row);
          });
        }
      }
      window.updateEngagementUI = updateEngagementUI;

      // --- Current question + flow ---
      let current = null;
      function nextQuestion() {
        const strand = data.mode;
        const gen = gens[strand] || gens.pemdas;
        const g = gen();
        current = { strand, q: g.q, ans: g.ans, hinted: false, t0: performance.now(), hintText: g.hint || 'Try breaking it into smaller steps.' };
        const qEl = document.getElementById('question');
        const aEl = document.getElementById('answer');
        const fb = document.getElementById('feedback');
        const hint = document.getElementById('hint');
        if (qEl) qEl.textContent = g.q;
        if (aEl) aEl.value = '';
        if (fb) { fb.textContent = ''; fb.className = 'feedback'; }
        if (hint) { hint.textContent = ''; hint.style.display = 'none'; }
      }
      window.nextQuestion = nextQuestion;

      function checkAnswer() {
        const aEl = document.getElementById('answer');
        const fb = document.getElementById('feedback');
        if (!current || !aEl || !fb) return;
        const user = aEl.value;
        const elapsed = performance.now() - current.t0;
        const correct = eqAns(user, current.ans);
        if (correct) {
          data.xp += 10;
          data.streak = (data.streak || 0) + 1;
          data.rank = computeRank(data.xp);
          data.correct[current.strand] = (data.correct[current.strand] || 0) + 1;
          data.daily.solved = (data.daily.solved || 0) + 1;
          fb.textContent = 'Correct! +' + (current.hinted ? ' (with hint)' : '');
          fb.className = 'feedback good';
          celebrate('correct');
          applyChallengeProgress({ correct: true, noHint: !current.hinted, strand: current.strand, ms: elapsed, streak: data.streak });
        } else {
          data.streak = 0;
          fb.textContent = `Not quite. Correct answer was: ${typeof current.ans === 'number' ? current.ans : String(current.ans)}`;
          fb.className = 'feedback bad';
        }
        // record attempt
        (data.hist[current.strand] = data.hist[current.strand] || []).push({
          t: Date.now(), correct, hint: current.hinted, ms: Math.round(elapsed)
        });
        // trim history lightly
        if (data.hist[current.strand].length > 400) data.hist[current.strand] = data.hist[current.strand].slice(-300);

        updateHUD();
        updateProgress();
        updateEngagementUI();
        save();
      }

      function showHint() {
        if (!current) return;
        const hint = document.getElementById('hint');
        if (!hint) return;
        if (!current.hinted) {
          current.hinted = true;
          data.xp = Math.max(0, (data.xp || 0) - 5);
          data.rank = computeRank(data.xp);
          updateHUD(); save();
        }
        hint.textContent = current.hintText;
        hint.style.display = '';
      }

      // --- Controls ---
      function bindControls() {
        const submit = document.getElementById('submit');
        const newQ = document.getElementById('newQ');
        const hintBtn = document.getElementById('hintBtn');
        const ans = document.getElementById('answer');
        if (submit && !submit.dataset.bound) { submit.addEventListener('click', checkAnswer); submit.dataset.bound = '1'; }
        if (newQ && !newQ.dataset.bound) { newQ.addEventListener('click', nextQuestion); newQ.dataset.bound = '1'; }
        if (hintBtn && !hintBtn.dataset.bound) { hintBtn.addEventListener('click', showHint); hintBtn.dataset.bound = '1'; }
        if (ans && !ans.dataset.bound) {
          ans.addEventListener('keydown', e => { if (e.key === 'Enter') checkAnswer(); });
          ans.dataset.bound = '1';
        }
        document.addEventListener('keydown', e => {
          if (e.key === 'n' || e.key === 'N') nextQuestion();
          else if (e.key === 'h' || e.key === 'H') showHint();
        }, { once: true }); // only bind once
      }
      bindControls();

      function randomizeStartMode() {
        const m = STRANDS[(Math.random() * STRANDS.length) | 0];
        data.mode = m;
        const btn = document.querySelector(`.navBtn[data-mode="${m}"]`);
        if (btn) setActiveNav(btn);
      }

      function initialStart() {
        randomizeStartMode();
        renderMode();
        if (data.themePref === 'auto') callIf(window.applyTheme, themeForMode(data.mode));
        updateHUD(); updateProgress(); paintBadges(); callIf(window.updateEngagementUI);
        save();
        callIf(window.nextQuestion);
        // Optional: validate gens if present
        if (window.gens && typeof window.gens === 'object') {
          try {
            STRANDS.forEach(k => {
              const g = window.gens[k] && window.gens[k]();
              if (!g || typeof g.q !== 'string' || typeof g.ans === 'undefined') console.warn('Quest generator invalid:', k, g);
            });
          } catch (e) { console.warn('Quest validation error:', e); }
        }
      }

      initialStart();
    })();
  </script>
</body>

</html>