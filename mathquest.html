<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CS Math Quest ‚Äî Catch‚ÄëUp Arcade</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121935;
      --panel2: #0e1530;
      --acc: #6cf;
      --acc2: #9f6cff;
      --good: #2ecc71;
      --bad: #e74c3c;
      --text: #e6ecff;
      --muted: #9fb0d7;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: radial-gradient(1000px 600px at 80% -10%, #1e2c6f22 0, transparent 60%), radial-gradient(1200px 800px at -10% 110%, #9f6cff14 0, transparent 70%), var(--bg);
      color: var(--text);
      font: 16px/1.4 system-ui, Segoe UI, Roboto, Inter, sans-serif
    }

    .app {
      display: grid;
      grid-template-columns: 280px 1fr;
      min-height: 100vh
    }

    header {
      grid-column: 1/-1;
      background: linear-gradient(90deg, var(--panel2), #1a2555);
      padding: 14px 18px;
      border-bottom: 1px solid #263164;
      display: flex;
      align-items: center;
      gap: 16px
    }

    header h1 {
      font-size: 20px;
      margin: 0;
      letter-spacing: .4px
    }

    .stat {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #0b1230;
      border: 1px solid #2a3672;
      padding: 6px 10px;
      border-radius: 10px
    }

    .stat b {
      color: #fff
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-left: auto
    }

    .side {
      background: linear-gradient(180deg, var(--panel), #0c1433);
      border-right: 1px solid #28346e;
      padding: 12px
    }

    .sectionTitle {
      margin: 10px 0 6px;
      color: #bcd3ff;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 1.4px
    }

    .navBtn {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #2a3672;
      background: #0b1230;
      color: #e6ecff;
      cursor: pointer;
      margin: 6px 0;
      transition: .15s
    }

    .navBtn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px #0005
    }

    .navBtn.active {
      outline: 2px solid var(--acc)
    }

    .progress {
      height: 6px;
      background: #19224b;
      border-radius: 999px;
      overflow: hidden
    }

    .progress>span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, var(--acc), var(--acc2));
      width: 0%
    }

    main {
      padding: 18px 18px 48px
    }

    .card {
      background: linear-gradient(180deg, var(--panel), #0f1738);
      border: 1px solid #2b3a78;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 30px #0006
    }

    .grid {
      display: grid;
      gap: 16px
    }

    @media(min-width:980px) {
      .grid {
        grid-template-columns: 1.1fr .9fr
      }
    }

    h2 {
      margin: 4px 0 12px
    }

    .question {
      font-size: 22px;
      letter-spacing: .2px
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace
    }

    .pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #34448a;
      background: #0b1230;
      color: #bcd3ff;
      font-size: 12px
    }

    input[type=number],
    input[type=text] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #2c3a77;
      background: #0d1433;
      color: #e6ecff
    }

    .btn {
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid #2c3a77;
      background: linear-gradient(180deg, #1a2555, #0d1433);
      color: #fff;
      cursor: pointer
    }

    .btn:hover {
      filter: brightness(1.08)
    }

    .btn.ghost {
      background: #0b1230
    }

    .feedback {
      margin-top: 10px;
      font-weight: 700
    }

    .good {
      color: var(--good)
    }

    .bad {
      color: var(--bad)
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #151e44;
      border: 1px solid #2a3672;
      border-radius: 12px;
      padding: 6px 10px;
      margin: 4px 6px 0 0
    }

    .tiny {
      font-size: 12px;
      color: var(--muted)
    }

    .hint {
      margin-top: 10px;
      color: #ffd980
    }

    .kbd {
      border: 1px solid #2a3672;
      border-bottom-width: 3px;
      border-radius: 8px;
      padding: 2px 6px;
      background: #0b1230
    }

    .flex {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    .right {
      margin-left: auto
    }

    .footer {
      opacity: .8;
      font-size: 12px;
      margin-top: 8px
    }

    /* FX canvas behind content */
    #fx {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 0;
    }

    /* ensure UI sits above FX */
    header,
    .app {
      position: relative;
      z-index: 1;
    }

    /* Mastery glow */
    .pill.mastered {
      color: #ffd76a;
      border-color: #ffcf67;
      box-shadow: 0 0 12px #ffcf6755, inset 0 0 8px #ffcf6722;
      background: linear-gradient(180deg, #1d1a08, #0f0b02);
    }

    /* Subtle hover lift */
    .btn:hover {
      box-shadow: 0 6px 16px #0007;
      transform: translateY(-1px);
    }

    /* Symbol legend */
    .legend-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px 12px;
      margin-top: 8px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .legend-sym {
      min-width: 44px;
      text-align: center;
      font-size: 20px;
      padding: 4px 8px;
      border: 1px solid #2a3672;
      border-radius: 10px;
      background: #0b1230;
      color: #e6ecff;
    }

    .legend-note {
      font-size: 12px;
      color: var(--muted);
    }

    /* Engagement UI */
    .meter {
      height: 8px;
      background: #19224b;
      border-radius: 999px;
      overflow: hidden;
    }

    .meter>span {
      display: block;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #2ecc71, #6cf);
      transition: width .3s;
    }

    .challenge {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 8px;
      border: 1px solid #2a3672;
      border-radius: 10px;
      background: #0b1230;
    }

    .challenge.done {
      opacity: .7;
      filter: saturate(.7);
    }

    .challenge .prog {
      margin-left: auto;
      font-size: 12px;
      color: var(--muted);
    }

    .challenge .check {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 1px solid #2a3672;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #0d1433;
      color: #2ecc71;
    }

    .stats-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin: 6px 0;
    }

    .stats-row .pill {
      min-width: 140px;
      text-align: center;
    }

    .muted {
      color: var(--muted);
    }
  </style>
</head>

<body>
  <canvas id="fx" aria-hidden="true"></canvas>
  <header>
    <h1>üïπÔ∏è CS Math Quest</h1>
    <div class="row">
      <div class="stat" title="Experience Points"><span>‚≠ê</span> <span>XP:</span> <b id="xp">0</b></div>
      <div class="stat" title="Streak"><span>üî•</span> <span>Streak:</span> <b id="streak">0</b></div>
      <div class="stat" title="Rank"><span>üèÜ</span> <span>Rank:</span> <b id="rank">Novice</b></div>
      <button class="btn ghost" id="resetBtn" title="Reset progress">‚Ü∫ Reset</button>
    </div>
  </header>
  <div class="app">
    <aside class="side">
      <div class="sectionTitle">Quest Map</div>
      <button class="navBtn active" data-mode="pemdas">Q1) Temple of PEMDAS <span class="pill mono"
          id="p_pemdas">0/10</span></button>
      <button class="navBtn" data-mode="integers">Q2) Integer Ice Caves <span class="pill mono"
          id="p_integers">0/10</span></button>
      <button class="navBtn" data-mode="coords">Q3) Quadrant Frontier <span class="pill mono"
          id="p_coords">0/10</span></button>
      <button class="navBtn" data-mode="words">Q4) Wordsmith Workshop <span class="pill mono"
          id="p_words">0/10</span></button>
      <button class="navBtn" data-mode="puzzles">Q5) Puzzle Portal <span class="pill mono"
          id="p_puzzles">0/10</span></button>
      <div class="sectionTitle">Progress</div>
      <div class="tiny" title="Mastery is checked on a rolling window of your last 20 attempts in each strand.">
        Mastery = 90%+ over last 20, 25+ attempts total, ‚â§10% hints, median ‚â§25s, across ‚â•2 days.
      </div>
      <div class="progress" style="margin:8px 0 6px"><span id="overallBar"></span></div>
      <div class="tiny" id="overallPct">0% complete</div>
      <div class="sectionTitle">Badges</div>
      <div id="badges"></div>
    </aside>

    <main>
      <div class="grid">
        <section class="card">
          <h2 id="modeTitle">Q1: Temple of PEMDAS</h2>
          <div class="tiny">Tip: Use parentheses like you would in code to control precedence.</div>
          <div id="qWrap" style="margin-top:10px">
            <div class="question mono" id="question">Loading‚Ä¶</div>
            <div class="flex" style="margin-top:12px">
              <input id="answer" type="text" inputmode="numeric" placeholder="Enter your answer" />
              <button class="btn" id="submit">Submit</button>
              <button class="btn ghost" id="newQ">New</button>
              <button class="btn ghost" id="hintBtn" title="Costs 5 XP">üí° Hint</button>
              <span class="right pill" id="strandLabel">PEMDAS</span>
            </div>
            <div class="feedback" id="feedback"></div>
            <div class="hint" id="hint" style="display:none"></div>
          </div>
          <div class="footer">Keyboard: <span class="kbd">Enter</span> to submit, <span class="kbd">N</span> new, <span
              class="kbd">H</span> hint.</div>
        </section>

        <section class="card">
          <h3>Strand Progress</h3>
          <div class="flex">
            <div class="pill">PEMDAS</div>
            <div class="progress" style="flex:1"><span id="bar_pemdas"></span></div>
          </div>
          <div class="flex">
            <div class="pill">Integers</div>
            <div class="progress" style="flex:1"><span id="bar_integers"></span></div>
          </div>
          <div class="flex">
            <div class="pill">Coordinates</div>
            <div class="progress" style="flex:1"><span id="bar_coords"></span></div>
          </div>
          <div class="flex">
            <div class="pill">Word</div>
            <div class="progress" style="flex:1"><span id="bar_words"></span></div>
          </div>
          <div class="flex">
            <div class="pill">Puzzles</div>
            <div class="progress" style="flex:1"><span id="bar_puzzles"></span></div>
          </div>
          <div style="margin-top:10px" class="tiny">
            When mastered, the strand pill shows ‚ÄúMastered‚Äù and the bar fills. Correct = +10 XP (+2/step streak), Hint =
            ‚àí5 XP.
          </div>
        </section>

        <!-- NEW: Symbol Legend card -->
        <section class="card">
          <h3>Symbol Legend</h3>
          <div class="legend-grid">
            <div class="legend-item"><span class="legend-sym">√ó</span>
              <div>Multiply <span class="legend-note">(keyboard: <span class="kbd">*</span>)</span></div>
            </div>
            <div class="legend-item"><span class="legend-sym">√∑</span>
              <div>Divide <span class="legend-note">(keyboard: <span class="kbd">/</span>)</span></div>
            </div>
            <div class="legend-item"><span class="legend-sym">¬∑</span>
              <div>Multiply dot <span class="legend-note">(same as √ó)</span></div>
            </div>
            <div class="legend-item"><span class="legend-sym">‚àí</span>
              <div>Subtract <span class="legend-note">(keyboard: <span class="kbd">-</span>)</span></div>
            </div>
            <div class="legend-item"><span class="legend-sym">+</span>
              <div>Add</div>
            </div>
            <div class="legend-item"><span class="legend-sym">=</span>
              <div>Equals</div>
            </div>
            <div class="legend-item"><span class="legend-sym">‚â†</span>
              <div>Not equal</div>
            </div>
            <div class="legend-item"><span class="legend-sym">‚â§ ‚â•</span>
              <div>Less/Greater than or equal</div>
            </div>
            <div class="legend-item"><span class="legend-sym">¬±</span>
              <div>Plus or minus</div>
            </div>
            <div class="legend-item"><span class="legend-sym">^</span>
              <div>Exponent <span class="legend-note">(e.g., 2^3 = 8)</span></div>
            </div>
            <div class="legend-item"><span class="legend-sym">|x|</span>
              <div>Absolute value</div>
            </div>
            <div class="legend-item"><span class="legend-sym">‚àö</span>
              <div>Square root <span class="legend-note">(type <span class="kbd">sqrt()</span>)</span></div>
            </div>
            <div class="legend-item"><span class="legend-sym">œÄ</span>
              <div>Pi <span class="legend-note">(‚âà 3.14159)</span></div>
            </div>
          </div>
          <div class="tiny" style="margin-top:8px;">Tip: The game accepts keyboard symbols like <span
              class="kbd">*</span>, <span class="kbd">/</span>, <span class="kbd">-</span>, and <span
              class="kbd">^</span>.</div>
        </section>

        <!-- NEW: Daily Goal -->
        <section class="card">
          <h3>Daily Goal</h3>
          <div class="tiny">Solve problems today to build strong habits.</div>
          <div class="flex" style="margin-top:8px">
            <div class="pill">Today</div>
            <div class="right tiny">Completed: <b id="dailyCount">0/20</b></div>
          </div>
          <div class="meter" style="margin-top:8px"><span id="dailyBar"></span></div>
          <div class="tiny" id="dailyHint" style="margin-top:6px; opacity:.9">Tip: Keep a streak going for bonus XP.
          </div>
        </section>

        <!-- NEW: Daily Challenges -->
        <section class="card">
          <h3>Daily Challenges</h3>
          <div class="tiny">Complete mini‚Äëgoals for extra XP and fun.</div>
          <div id="challenges" style="display:grid; gap:8px; margin-top:8px"></div>
        </section>

        <!-- NEW: Strand Stats -->
        <section class="card">
          <h3>Strand Stats</h3>
          <div id="statsBox" class="tiny"></div>
        </section>
      </div>
    </main>
  </div>

  <script>
    (function () {
      // --- FX: starfield + confetti ---
      const fx = document.getElementById('fx');
      const ctx = fx.getContext('2d');
      let W = 0,
        H = 0,
        stars = [],
        confetti = [];

      function resizeFX() {
        W = fx.width = window.innerWidth;
        H = fx.height = window.innerHeight;
      }
      window.addEventListener('resize', resizeFX);
      resizeFX();

      function initStars(n = 120) {
        stars = Array.from({ length: n }, () => ({
          x: Math.random() * W,
          y: Math.random() * H,
          r: Math.random() * 1.2 + 0.3,
          a: Math.random() * Math.PI * 2,
          s: 0.2 + Math.random() * 0.6
        }));
      }
      initStars();

      function addConfetti({
        x = W / 2,
        y = H / 2,
        count = 80,
        spread = 1,
        colors = ['#6cf', '#9f6cff', '#2ecc71', '#ffd76a']
      } = {}) {
        for (let i = 0; i < count; i++) {
          const ang = Math.random() * Math.PI * 2;
          const spd = (2 + Math.random() * 4) * spread;
          confetti.push({
            x,
            y,
            vx: Math.cos(ang) * spd,
            vy: Math.sin(ang) * spd - 2,
            g: 0.06 + Math.random() * 0.08,
            life: 60 + Math.random() * 40,
            color: colors[(Math.random() * colors.length) | 0],
            w: 2 + Math.random() * 3,
            h: 6 + Math.random() * 8,
            rot: Math.random() * Math.PI,
            vr: (Math.random() - 0.5) * 0.3,
            alpha: 1
          });
        }
      }

      function fxLoop() {
        // clear
        ctx.clearRect(0, 0, W, H);

        // stars
        ctx.save();
        for (const st of stars) {
          st.a += 0.02;
          const tw = (Math.sin(st.a) + 1) * 0.5; // 0..1
          ctx.globalAlpha = 0.3 + tw * 0.7;
          ctx.fillStyle = '#9fb0d7';
          ctx.beginPath();
          ctx.arc(st.x, st.y, st.r, 0, Math.PI * 2);
          ctx.fill();
          st.y += st.s * 0.15;
          if (st.y > H + 2) {
            st.y = -2;
            st.x = Math.random() * W;
          }
        }
        ctx.restore();

        // confetti
        ctx.save();
        for (let i = confetti.length - 1; i >= 0; i--) {
          const p = confetti[i];
          p.vy += p.g;
          p.x += p.vx;
          p.y += p.vy;
          p.rot += p.vr;
          p.life -= 1;
          p.alpha = Math.max(0, p.life / 100);
          ctx.globalAlpha = p.alpha;
          ctx.fillStyle = p.color;
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
          ctx.setTransform(1, 0, 0, 1, 0, 0);
          if (p.life <= 0 || p.y > H + 20) confetti.splice(i, 1);
        }
        ctx.restore();

        requestAnimationFrame(fxLoop);
      }
      requestAnimationFrame(fxLoop);

      function celebrate(kind = 'correct') {
        const anchor = document.getElementById('qWrap');
        const rect = anchor ? anchor.getBoundingClientRect() : { left: W / 2, top: H / 3, width: 0, height: 0 };
        const cx = (rect.left + rect.right) / 2;
        const cy = rect.top + 10;
        if (kind === 'mastery') {
          addConfetti({ x: cx, y: cy, count: 160, spread: 1.4, colors: ['#ffd76a', '#ffcf67', '#fff2b0', '#9f6cff'] });
        } else {
          addConfetti({ x: cx, y: cy, count: 80, spread: 1.0 });
        }
      }

      // expose inside closure
      // --- existing game code starts here ---

      const state = JSON.parse(localStorage.getItem('csMathQuest') || '{}');
      const data = Object.assign({
        xp: 0,
        streak: 0,
        rank: "Novice",
        mode: "pemdas",
        correct: { pemdas: 0, integers: 0, coords: 0, words: 0, puzzles: 0 },
        hist: { pemdas: [], integers: [], coords: [], words: [], puzzles: [] },
        mastered: { pemdas: false, integers: false, coords: false, words: false, puzzles: false },
        // NEW: engagement state
        daily: { date: "", solved: 0, goal: 20, completed: false },
        challenges: [],
        badges: {},
        boss: { done: false },
      }, state);

      // helpers already here:
      function $(sel) { return document.querySelector(sel); }
      function setText(sel, val) { const el = document.querySelector(sel); if (el) el.textContent = val; }
      function clamp(x, a, b) { return Math.max(a, Math.min(b, x)); }
      function fmtPct(n) { return Math.round(n * 100) + "%"; }

      // NEW: core app helpers (add right after helpers above)
      function save() {
        try { localStorage.setItem('csMathQuest', JSON.stringify(data)); } catch (_) { /* ignore */ }
      }
      function updateHUD() {
        setText('#xp', String(data.xp));
        setText('#streak', String(data.streak));
        setText('#rank', data.rank);
      }
      function paintBadges() {
        const box = document.getElementById('badges');
        if (!box) return;
        box.innerHTML = '';
        Object.values(data.badges || {}).forEach(label => {
          const el = document.createElement('div');
          el.className = 'badge';
          el.innerHTML = `üèÖ <span>${label}</span>`;
          box.appendChild(el);
        });
      }
      function toast(msg) {
        const el = document.createElement('div');
        el.textContent = msg;
        Object.assign(el.style, {
          position: 'fixed', top: '12px', right: '12px', zIndex: 9999,
          background: '#151e44', color: '#fff', border: '1px solid #2a3672',
          padding: '8px 10px', borderRadius: '10px', boxShadow: '0 6px 20px #0008',
          opacity: '0', transform: 'translateY(-6px)', transition: 'opacity .2s, transform .2s'
        });
        document.body.appendChild(el);
        requestAnimationFrame(() => { el.style.opacity = '1'; el.style.transform = 'translateY(0)'; });
        setTimeout(() => {
          el.style.opacity = '0'; el.style.transform = 'translateY(-6px)';
          setTimeout(() => el.remove(), 250);
        }, 2000);
      }

      // NEW: mastery helpers + compute function
      function median(arr) { if (!arr.length) return 0; const s = [...arr].sort((a, b) => a - b); const m = Math.floor(s.length / 2); return s.length % 2 ? s[m] : (s[m - 1] + s[m]) / 2; }
      function dayKey(ts) { const d = new Date(ts); return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`; }
      function computeMasteryFor(strand) {
        const attempts = data.hist[strand] || [];
        const total = attempts.length;
        const window20 = attempts.slice(-20);
        if (total < 25 || window20.length < 20) return false;
        const acc = window20.reduce((s, a) => s + (a.correct ? 1 : 0), 0) / window20.length;
        if (acc < 0.90) return false;
        const days = new Set(window20.map(a => dayKey(a.t))).size;
        if (days < 2) return false;
        const medMs = median(window20.map(a => a.ms || 0));
        if (medMs > 25000) return false;
        const hintRate = window20.reduce((s, a) => s + (a.hint ? 1 : 0), 0) / window20.length;
        if (hintRate > 0.10) return false;
        return true;
      }

      // NEW: progress bar + mastery UI updater
      function updateProgress() {
        // Recompute mastery first
        recomputeMastery();

        ['pemdas', 'integers', 'coords', 'words', 'puzzles'].forEach(k => {
          if (data.mastered[k]) {
            setText('#p_' + k, 'Mastered');
            $('#bar_' + k).style.width = '100%';
          } else {
            setText('#p_' + k, `${data.correct[k]}/10`);
            $('#bar_' + k).style.width = Math.min(100, data.correct[k] * 10) + '%';
          }
          const pill = document.getElementById('p_' + k);
          if (pill) pill.classList.toggle('mastered', !!data.mastered[k]);
        });
        const total = Object.values(data.correct).reduce((a, b) => a + b, 0);
        $('#overallBar').style.width = clamp(total / 50, 0, 1) * 100 + '%';
        setText('#overallPct', fmtPct(clamp(total / 50, 0, 1)));
      }

      // Ranks
      function computeRank(xp) {
        if (xp >= 300) return 'Architect';
        if (xp >= 150) return 'Hacker';
        if (xp >= 50) return 'Coder';
        return 'Novice';
      }

      // UI init
      const navBtns = [...document.querySelectorAll('.navBtn')];
      navBtns.forEach(btn => btn.addEventListener('click', () => {
        navBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        data.mode = btn.dataset.mode;
        renderMode();
        nextQuestion();
        save();
      }));

      $('#resetBtn').addEventListener('click', () => {
        if (!confirm('Reset XP and progress?')) return;
        Object.assign(data, { xp: 0, streak: 0, rank: 'Novice', correct: { pemdas: 0, integers: 0, coords: 0, words: 0, puzzles: 0 }, badges: {}, boss: { done: false } });
        updateHUD();
        updateProgress();
        nextQuestion();
        save();
      });

      // Question generators
      const R = (a, b) => Math.floor(Math.random() * (b - a + 1)) + a;
      const choice = arr => arr[R(0, arr.length - 1)];

      const gens = {
        pemdas() {
          const t = choice([0, 1, 2, 3]);
          let q, ans, hint;
          const a = R(2, 9),
            b = R(2, 9),
            c = R(2, 9),
            d = R(1, 5);
          switch (t) {
            case 0:
              q = `${a} + ${b} * ${c}`;
              ans = a + b * c;
              hint = 'Remember √ó before +.';
              break;
            case 1:
              q = `(${a} + ${b}) * ${c}`;
              ans = (a + b) * c;
              hint = 'Parentheses first, then √ó.';
              break;
            case 2:
              q = `${a}^2 - ${d}^2`;
              ans = a * a - d * d;
              hint = 'Square then subtract.';
              break;
            case 3:
              q = `${a} + ${b} * (${c} + ${d})`;
              ans = a + b * (c + d);
              hint = 'Do the () then √ó then +.';
              break;
          }
          return { q, ans, hint };
        },
        integers() {
          const t = choice(['add', 'sub', 'mul', 'div']);
          let x = R(-15, 15),
            y = R(-15, 15);
          if (t === 'div') {
            y = choice([-10, -5, -2, 2, 5, 10]);
            x = y * R(-5, 5);
          }
          let q, ans, hint;
          if (t === 'add') {
            q = `${x} + ${y}`;
            ans = x + y;
            hint = 'Use a number line: move right for +, left for ‚àí.'
          }
          if (t === 'sub') {
            q = `${x} - (${y})`;
            ans = x - y;
            hint = 'Keep‚ÄëChange‚ÄëFlip: a‚àí(b) = a + (‚àíb).'
          }
          if (t === 'mul') {
            q = `(${x}) * (${y})`;
            ans = x * y;
            hint = 'Sign rule: (‚àí√ó‚àí)=+, (‚àí√ó+)=‚àí.'
          }
          if (t === 'div') {
            q = `(${x}) / (${y})`;
            ans = x / y;
            hint = 'Division keeps sign rules too.'
          }
          return { q, ans, hint };
        },
        coords() {
          const t = choice(['quad', 'reflectX', 'reflectY', 'translate']);
          const x = R(-8, 8),
            y = R(-8, 8);
          let q, ans, hint;
          if (t === 'quad') {
            q = `Which quadrant is (${x}, ${y})? (Enter I, II, III, IV or axis)`;
            const quad = x === 0 || y === 0 ? 'axis' : x > 0 && y > 0 ? 'I' : x < 0 && y > 0 ? 'II' : x < 0 && y < 0 ? 'III' : 'IV';
            ans = quad;
            hint = 'Sign of x then sign of y.';
          }
          if (t === 'reflectX') {
            q = `Reflect (${x}, ${y}) across the x‚Äëaxis. Enter as x,y`;
            ans = `${x},${-y}`;
            hint = 'Flip the sign of y.';
          }
          if (t === 'reflectY') {
            q = `Reflect (${x}, ${y}) across the y‚Äëaxis. Enter as x,y`;
            ans = `${-x},${y}`;
            hint = 'Flip the sign of x.';
          }
          if (t === 'translate') {
            const dx = R(-5, 5),
              dy = R(-5, 5);
            q = `Translate (${x}, ${y}) by Œîx=${dx}, Œîy=${dy}. Enter as x,y`;
            ans = `${x + dx},${y + dy}`;
            hint = 'Add Œîx to x and Œîy to y.';
          }
          return { q, ans, hint, normalize: (s) => s.replace(/\s+/g, '').toUpperCase() };
        },
        words() {
          const t = choice(['temp', 'bank', 'elev', 'rate']);
          let q, ans, hint;
          if (t === 'temp') {
            const start = R(-10, 5),
              up = R(3, 12),
              down = R(2, 9);
            q = `Temperature starts at ${start}¬∞; rises ${up}¬∞, then drops ${down}¬∞. Final temp?`;
            ans = start + up - down;
            hint = 'Translate: start + up ‚àí down.';
          }
          if (t === 'bank') {
            const bal = R(-20, 10),
              dep = R(10, 40),
              cost = R(3, 15);
            q = `Account balance $${bal}. Deposit $${dep}, then buy a snack for $${cost}. New balance?`;
            ans = bal + dep - cost;
            hint = 'Deposit adds, purchase subtracts.';
          }
          if (t === 'elev') {
            const start = -R(5, 40),
              up = R(5, 20),
              down = R(1, 15);
            q = `Start ${Math.abs(start)} ft below sea level. Ascend ${up} ft; descend ${down} ft. Final elevation (signed)?`;
            ans = start + up - down;
            hint = 'Below sea level is negative.';
          }
          if (t === 'rate') {
            const speed = choice([20, 30, 40, 50]),
              time = choice([0.5, 1, 1.5, 2]);
            q = `You travel at ${speed} mi/hr for ${time} hr. How many miles?`;
            ans = speed * time;
            hint = 'Distance = rate √ó time.';
          }
          return { q, ans, hint };
        },
        puzzles() {
          const t = choice(['stairs', 'sequence', 'grid']);
          let q, ans, hint;
          if (t === 'stairs') {
            const rise = choice([0.5, 0.75, 0.25]),
              total = choice([8, 10, 12, 15]);
            q = `A staircase rises ${total} ft with ${rise}‚Äëft rises. How many steps?`;
            ans = Math.round(total / rise);
            hint = 'Steps = total √∑ rise.';
          }
          if (t === 'sequence') {
            const start = R(-5, 10),
              step = R(2, 9),
              n = R(5, 12);
            q = `Arithmetic sequence starts at ${start}, step +${step}. What is term #${n}?`;
            ans = start + (n - 1) * step;
            hint = 'a_n = a_1 + (n‚àí1)d';
          }
          if (t === 'grid') {
            const x1 = R(-3, 1),
              y1 = R(1, 4),
              x2 = R(3, 7),
              y2 = R(-4, -1);
            q = `From (${x1},${y1}) to (${x2},${y2}) moving only right or down. Shortest path length (grid steps)?`;
            ans = (x2 - x1) + (y1 - y2);
            hint = 'Œîx right + Œîy down.';
          }
          return { q, ans, hint };
        }
      };

      // Boss mix
      function bossGen() {
        const pick = choice(['pemdas', 'integers', 'coords', 'words', 'puzzles']);
        let g = gens[pick]();
        g.strand = pick;
        return g;
      }

      let current = { q: '', ans: null, hint: '', normalize: null, strand: null };
      function renderMode() {
        const titles = {
          pemdas: 'Q1: Temple of PEMDAS',
          integers: 'Q2: Integer Ice Caves',
          coords: 'Q3: Quadrant Frontier',
          words: 'Q4: Wordsmith Workshop',
          puzzles: 'Q5: Puzzle Portal',
          boss: 'Boss Battle: Final Gauntlet'
        };
        const shortPills = {
          pemdas: 'Q1',
          integers: 'Q2',
          coords: 'Q3',
          words: 'Q4',
          puzzles: 'Q5',
          boss: 'BOSS'
        };
        setText('#modeTitle', titles[data.mode] || 'Quest');
        const label = document.getElementById('strandLabel');
        if (label) label.textContent = shortPills[data.mode] || 'Q?';
      }

      function nextQuestion() {
        $('#feedback').textContent = '';
        $('#hint').style.display = 'none';
        $('#answer').value = '';
        const g = (data.mode === 'boss') ? bossGen() : gens[data.mode]();
        // NEW: track hint + start time on the current question
        current = Object.assign({}, g, { hinted: false, started: Date.now() });
        $('#question').textContent = g.q;
        $('#answer').focus();
      }

      // AUDIO: tiny Web Audio sound kit (no audio files needed)
      const audio = (() => {
        const AC = window.AudioContext || window.webkitAudioContext;
        const ctx = new AC();

        // ensure audio can start (user gesture)
        const resume = () => { if (ctx.state === 'suspended') ctx.resume(); };
        document.addEventListener('pointerdown', resume, { once: true, capture: true });
        document.addEventListener('keydown', resume, { once: true, capture: true });

        function blip({ freq = 440, dur = 0.12, type = 'sine', vol = 0.15, sweep = 0 }) {
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = type;
          o.frequency.value = freq;
          const now = ctx.currentTime;
          // envelope
          g.gain.setValueAtTime(0.0001, now);
          g.gain.exponentialRampToValueAtTime(vol, now + 0.01);
          g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
          if (sweep) o.frequency.exponentialRampToValueAtTime(Math.max(40, freq + sweep), now + dur);
          o.connect(g).connect(ctx.destination);
          o.start(now);
          o.stop(now + dur + 0.02);
        }
        function arp(notes = [440, 554, 659], step = 0.08, type = 'triangle', vol = 0.18) {
          notes.forEach((f, i) => setTimeout(() => blip({ freq: f, type, dur: 0.12, vol }), i * step * 1000));
        }
        return {
          click() { blip({ freq: 700, dur: 0.05, type: 'square', vol: 0.08 }); },
          correct() { arp([520, 660, 880], 0.07, 'sine', 0.16); },
          wrong() { blip({ freq: 180, dur: 0.25, type: 'sawtooth', vol: 0.12, sweep: -120 }); },
          badge() { arp([660, 880, 990, 1320], 0.07, 'triangle', 0.18); },
          mastery() { arp([523, 659, 784, 1046], 0.09, 'triangle', 0.2); },
          rank() { arp([392, 523, 659, 784], 0.09, 'sine', 0.18); }
        };
      })();

      // Rank up sound
      function awardXP(base) {
        let bonus = Math.max(0, (data.streak - 1) * 2); // +2 per extra streak
        data.xp = Math.max(0, data.xp + base + bonus);
        const oldRank = data.rank;
        data.rank = computeRank(data.xp);
        if (oldRank !== data.rank) { toast(`üéñÔ∏è Rank Up: ${data.rank}!`); audio.rank(); }
      }

      // Badge sound
      function addBadge(key, label) {
        if (data.badges[key]) return;
        data.badges[key] = label; paintBadges(); toast(`üèÖ Badge unlocked: ${label}`);
        audio.badge();
      }

      // Mastery fanfare (add sound alongside celebrate)
      function recomputeMastery() {
        ['pemdas', 'integers', 'coords', 'words', 'puzzles'].forEach(k => {
          const was = data.mastered[k];
          const now = computeMasteryFor(k);
          data.mastered[k] = now;
          if (!was && now) { addBadge('m_' + k, `Master: ${k}`); toast(`‚≠ê Mastered ${k}!`); celebrate('mastery'); audio.mastery(); }
        });
      }

      // Correct / wrong sounds
      function check() {
        const raw = $('#answer').value.trim();
        if (!raw) { $('#feedback').innerHTML = '<span class="bad">Enter an answer.</span>'; return; }

        let user = raw;
        if (current.normalize) { user = current.normalize(raw); }

        const ans = (typeof current.ans === 'number') ? Number(current.ans) : String(current.ans);
        let correct = false;
        if (typeof ans === 'number') {
          const guess = Number(user);
          correct = Math.abs(guess - ans) < 1e-9;
        } else {
          correct = String(user) === String(ans);
        }

        const strand = (data.mode === 'boss' ? current.strand : data.mode);
        const elapsed = Math.max(0, Date.now() - (current.started || Date.now()));

        // record attempt
        if (strand) {
          const rec = { t: Date.now(), strand, correct: correct ? 1 : 0, ms: elapsed, hint: current.hinted ? 1 : 0 };
          data.hist[strand] = (data.hist[strand] || []).concat(rec).slice(-200);
        }

        // NEW: engagement updates
        if (correct) {
          // Daily
          ensureDaily();
          if (!data.daily.completed) {
            data.daily.solved += 1;
            if (data.daily.solved >= data.daily.goal) {
              data.daily.completed = true;
              addBadge('daily_' + data.daily.date, 'Daily Goal Complete');
              toast('‚úÖ Daily goal complete!');
              celebrate('mastery');
            }
          }
          // Challenges
          applyChallengeProgress({ correct: true, noHint: !current.hinted, strand });
        }

        if (correct) {
          $('#feedback').innerHTML = `<span class="good">‚úî Correct!</span> <span class="tiny">+10 XP${data.streak ? ` +${Math.max(0, (data.streak) * 2)} streak bonus` : ''}</span>`;
          data.streak += 1;
          awardXP(10);
          if (strand) data.correct[strand] = Math.min(10, data.correct[strand] + 1);
          if (data.mode === 'boss') {
            data.boss.round = (data.boss.round || 0) + 1;
            if (data.boss.round >= 5) { data.boss.done = true; addBadge('boss', 'Boss Beaten'); data.boss.round = 0; }
          }
          updateHUD();
          updateProgress();
          updateEngagementUI(); // NEW
          save();
          nudgeNearMastery(strand); // NEW
          setTimeout(nextQuestion, 450);
        } else {
          $('#feedback').innerHTML = `<span class="bad">‚úñ Not quite.</span> <span class="tiny">Try a hint or new question.</span>`;
          data.streak = 0;
          updateHUD();
          updateProgress();
          updateEngagementUI(); // NEW
          save();
        }
      }

      // Click sounds
      document.getElementById('hintBtn').addEventListener('click', () => audio.click(), { capture: true });
      document.getElementById('submit').addEventListener('click', () => audio.click(), { capture: true });
      document.getElementById('newQ').addEventListener('click', () => audio.click(), { capture: true });

      // REPLACE OLD helper consts (moved above) ‚Äî remove these four lines if present:
      // const $ = sel => document.querySelector(sel);
      // const setText = (id, val) => { const el = $(id); if (el) el.textContent = val };
      // const clamp = (x, a, b) => Math.max(a, Math.min(b, x));
      // const fmtPct = n => Math.round(n * 100) + "%";

      // Bind actions (submit/new/hint) so the game advances
      document.getElementById('submit').addEventListener('click', () => check());
      document.getElementById('newQ').addEventListener('click', () => nextQuestion());
      document.getElementById('hintBtn').addEventListener('click', () => {
        if (current.hint) {
          const h = document.getElementById('hint');
          h.textContent = 'Hint: ' + current.hint + ' (‚àí5 XP)';
          h.style.display = 'block';
          current.hinted = true;
          data.xp = Math.max(0, data.xp - 5);
          updateHUD(); save();
        }
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { check(); }
        if (e.key.toLowerCase && e.key.toLowerCase() === 'n') { nextQuestion(); }
        if (e.key.toLowerCase && e.key.toLowerCase() === 'h') {
          const btn = document.getElementById('hintBtn');
          if (btn) btn.click();
        }
      });

      // Engagement: Daily + Challenges (add after helpers/mastery)
      function todayKey() { return new Date().toISOString().slice(0, 10); }

      function rollDailyChallenges() {
        const strands = ['pemdas', 'integers', 'coords', 'words', 'puzzles'];
        const pick = strands[Math.floor(Math.random() * strands.length)];
        // 3 simple challenges
        return [
          { id: 'c_strand', label: `Solve 5 in ${pick.toUpperCase()}`, type: 'strand', strand: pick, progress: 0, target: 5, done: false, reward: 25 },
          { id: 'c_streak', label: 'Get a 3‚Äëanswer streak', type: 'streak', progress: 0, target: 3, done: false, reward: 20 },
          { id: 'c_nohint', label: 'Answer 5 with no hints', type: 'nohint', progress: 0, target: 5, done: false, reward: 20 },
        ];
      }

      function ensureDaily() {
        const today = todayKey();
        if (!data.daily || data.daily.date !== today) {
          const goal = (data.daily && data.daily.goal) || 20;
          data.daily = { date: today, solved: 0, goal, completed: false };
          data.challenges = rollDailyChallenges();
          save();
        } else if (!Array.isArray(data.challenges) || !data.challenges.length) {
          data.challenges = rollDailyChallenges();
          save();
        }
        updateEngagementUI();
      }

      function updateEngagementUI() {
        // Daily meter
        const solved = data.daily?.solved || 0;
        const goal = data.daily?.goal || 20;
        const pct = Math.max(0, Math.min(1, solved / goal));
        const bar = document.getElementById('dailyBar');
        if (bar) bar.style.width = (pct * 100).toFixed(0) + '%';
        setText('#dailyCount', `${solved}/${goal}`);
        const hint = document.getElementById('dailyHint');
        if (hint) {
          hint.textContent = data.daily?.completed
            ? 'Great work! Daily goal complete. üéâ'
            : (goal - solved <= 5 ? 'So close! Just a few more to hit today‚Äôs goal.' : 'Tip: Keep a streak going for bonus XP.');
        }
        // Challenges list
        const box = document.getElementById('challenges');
        if (!box) return;
        box.innerHTML = '';
        (data.challenges || []).forEach(ch => {
          const row = document.createElement('div');
          row.className = 'challenge' + (ch.done ? ' done' : '');
          row.innerHTML = `
            <span class="check">${ch.done ? '‚úî' : ''}</span>
            <div>${ch.label}</div>
            <div class="prog">${Math.min(ch.progress, ch.target)}/${ch.target}</div>
          `;
          box.appendChild(row);
        });
      }

      function applyChallengeProgress({ correct, noHint, strand }) {
        let changed = false;
        for (const ch of (data.challenges || [])) {
          if (ch.done) continue;
          if (ch.type === 'strand' && correct && strand === ch.strand) { ch.progress++; changed = true; }
          if (ch.type === 'streak' && correct && data.streak > 0) {
            ch.progress = Math.max(ch.progress, Math.min(data.streak, ch.target)); changed = true;
          }
          if (ch.type === 'nohint' && correct && noHint) { ch.progress++; changed = true; }
          if (ch.progress >= ch.target && !ch.done) {
            ch.done = true; awardXP(ch.reward); addBadge(ch.id, ch.label + ` (+${ch.reward} XP)`); toast('üéØ Challenge complete!'); celebrate('correct');
            changed = true;
          }
        }
        if (changed) { updateEngagementUI(); save(); }
      }

      function nudgeNearMastery(strand) {
        if (!strand || data.mastered[strand]) return;
        const attempts = data.hist[strand] || [];
        const last = attempts.slice(-20);
        const total = attempts.length;
        const acc = last.length ? last.reduce((s, a) => s + (a.correct ? 1 : 0), 0) / last.length : 0;
        if (total >= 18 && last.length < 20) toast(`Almost there in ${strand}! Just ${20 - last.length} more recent attempts counted.`);
        else if (last.length === 20 && acc >= 0.80 && acc < 0.90) toast(`So close to mastering ${strand}! Push accuracy to 90% over last 20.`);
        else if (last.length === 20 && acc >= 0.90) toast(`Mastery in reach for ${strand}! Keep the speed and low hints.`);
      }

      // Stats helpers
      function msToStr(ms) { if (!ms) return '‚Äî'; const s = ms / 1000; return s < 1 ? s.toFixed(2) + 's' : s.toFixed(1) + 's'; }
      function calcStats(k) {
        const arr = (data.hist[k] || []).slice(-20);
        const n = arr.length;
        const acc = n ? arr.reduce((s, a) => s + (a.correct ? 1 : 0), 0) / n : 0;
        const med = median(arr.map(a => a.ms || 0));
        const hint = n ? arr.reduce((s, a) => s + (a.hint ? 1 : 0), 0) / n : 0;
        return { n, acc, med, hint };
      }
      function updateStatsUI() {
        const box = document.getElementById('statsBox'); if (!box) return;
        const labels = {
          pemdas: 'Q1 ‚Ä¢ PEMDAS',
          integers: 'Q2 ‚Ä¢ Integers',
          coords: 'Q3 ‚Ä¢ Coordinates',
          words: 'Q4 ‚Ä¢ Word Problems',
          puzzles: 'Q5 ‚Ä¢ Puzzles'
        };
        const strands = ['pemdas', 'integers', 'coords', 'words', 'puzzles'];
        box.innerHTML = strands.map(k => {
          const s = calcStats(k);
          const acc = Math.round((s.acc || 0) * 100);
          const hints = Math.round((s.hint || 0) * 100);
          return `
            <div class="stats-row">
              <div class="pill">${labels[k]}</div>
              <div>Accuracy: <b>${acc}%</b></div>
              <div>Median time: <b>${msToStr(s.med)}</b></div>
              <div>Hints: <b>${hints}%</b></div>
              <div class="muted">n=${s.n}</div>
            </div>
          `;
        }).join('');
      }

      // Wire stats updates into existing flow
      const _updateProgress = updateProgress;
      updateProgress = function () {
        _updateProgress();
        updateStatsUI();
      };

      // After check() updates UI, stats will refresh via updateProgress(); ensure an initial render too
      // Initial render
      renderMode();
      updateHUD();
      updateProgress(); // calls updateStatsUI()
      paintBadges();
      updateEngagementUI();
      nextQuestion();

      // ...existing code...
    })();
  </script>
</body>

</html>